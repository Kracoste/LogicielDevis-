<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Logiciel de Devis</title>
	<link rel="stylesheet" href="styles/output.css">
	<style>
		.drag-region {
			-webkit-app-region: drag;
		}
		.no-drag {
			-webkit-app-region: no-drag;
		}
		.sidebar-item {
			display: flex;
			align-items: center;
			width: 100%;
			padding: 12px 16px;
			text-align: left;
			color: #374151;
			background: transparent;
			border: none;
			border-radius: 8px;
			transition: all 0.2s;
			cursor: pointer;
		}
		.sidebar-item:hover {
			background-color: #f3f4f6;
		}
		.sidebar-item.active {
			background-color: #eff6ff;
			color: #2563eb;
			border-right: 2px solid #2563eb;
		}
		.tab-content {
			display: none;
		}
		.tab-content.active {
			display: block;
		}
		
		/* CSS FOR√áANT LA VUE NOUVEAU DEVIS √Ä PRENDRE TOUT L'√âCRAN */
		#newQuoteView {
			position: fixed !important;
			top: 0 !important;
			left: 0 !important;
			right: 0 !important;
			bottom: 0 !important;
			width: 100vw !important;
			height: 100vh !important;
			margin: 0 !important;
			padding: 0 !important;
			z-index: 9999 !important;
			background-color: #f3f4f6 !important;
			overflow-y: auto !important;
		}
		
		/* SOLUTION ULTRA-RADICALE - SUPPRIMER TOUS LES BOUTONS INVISIBLES */
		
		/* Zone Header "Nouveau Devis" - Ligne 328-335 */
		#newQuoteView .flex.items-center.justify-between.mb-4.bg-white.rounded-lg.shadow-sm.p-3.border * {
			cursor: default !important;
			pointer-events: none !important;
			user-select: none !important;
		}
		
		/* R√©activer SEULEMENT les vrais boutons dans le header */
		#newQuoteView #backToQuotesBtn,
		#newQuoteView #saveQuoteBtn {
			cursor: pointer !important;
			pointer-events: auto !important;
			user-select: auto !important;
		}
		
		/* Zone Prestations - Lignes 369-378 */
		#newQuoteView .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6 .flex.items-center.justify-between * {
			cursor: default !important;
			pointer-events: none !important;
			user-select: none !important;
		}
		
		/* R√©activer SEULEMENT le vrai bouton "Ajouter une prestation" */
		#newQuoteView #addServiceBtn {
			cursor: pointer !important;
			pointer-events: auto !important;
			user-select: auto !important;
		}
		
		/* Supprimer tous les pseudo-√©l√©ments et √©l√©ments cach√©s */
		#newQuoteView *:before,
		#newQuoteView *:after {
			display: none !important;
			content: none !important;
		}
		
		#newQuoteView .min-h-screen {
			min-height: 100vh !important;
			width: 100% !important;
		}
		
		/* Bouton retour - STYLE SIMPLE SANS CARR√â - ZONE CLIQUABLE AGRANDIE */
		#backToQuotesBtn {
			transition: all 0.2s ease !important;
			cursor: pointer !important;
			user-select: none !important;
			-webkit-user-select: none !important;
			-moz-user-select: none !important;
			-ms-user-select: none !important;
			color: #374151 !important;
			font-weight: 600 !important;
			font-size: 18px !important;
			padding: 12px 16px !important;
			border-radius: 6px !important;
			display: flex !important;
			align-items: center !important;
			gap: 8px !important;
			min-height: 44px !important;
			min-width: 120px !important;
			box-sizing: border-box !important;
			position: relative !important;
		}
		
		#backToQuotesBtn:hover {
			color: #111827 !important;
			background-color: rgba(243, 244, 246, 0.8) !important;
			transform: translateX(-2px) !important;
		}
		
		#backToQuotesBtn:active {
			transform: translateX(0) !important;
			background-color: rgba(229, 231, 235, 0.8) !important;
		}
	</style>
</head>
<body class="bg-gray-50 h-screen">
	<!-- Barre de titre personnalis√©e -->
	<div class="drag-region h-12 bg-white border-b border-gray-200 flex items-center justify-between px-4">
        <div class="flex items-center space-x-3">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            <span class="font-semibold text-gray-900">Logiciel de Devis</span>
        </div>
        
        <div class="no-drag flex items-center space-x-2">
            <button id="minimizeBtn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                </svg>
            </button>
            <button id="maximizeBtn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path>
                </svg>
            </button>
            <button id="closeBtn" class="p-2 hover:bg-red-100 hover:text-red-600 rounded-lg transition-colors">
                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Contenu principal -->
    <div class="flex h-[calc(100vh-3rem)]">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col">
            <!-- User info -->
            <div class="p-4 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                        <span id="userInitials" class="text-blue-600 font-semibold text-sm">U</span>
                    </div>
                    <div>
                        <div id="userName" class="font-medium text-gray-900">Utilisateur</div>
                        <div id="userCompany" class="text-sm text-gray-600">Mon Entreprise</div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 p-4 space-y-2">
                <button class="sidebar-item active" data-tab="dashboard">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6a2 2 0 01-2 2H10a2 2 0 01-2-2V5z"></path>
                    </svg>
                    <span>Tableau de bord</span>
                </button>

                <button class="sidebar-item" data-tab="quotes">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <span>Devis</span>
                    <span id="quotesCount" class="ml-auto px-2 py-1 text-xs bg-blue-100 text-blue-600 rounded-full">0</span>
                </button>

                <button class="sidebar-item" data-tab="clients">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    <span>Clients</span>
                    <span id="clientsCount" class="ml-auto px-2 py-1 text-xs bg-green-100 text-green-600 rounded-full">0</span>
                </button>

                <button class="sidebar-item" data-tab="settings">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span>Param√®tres</span>
                </button>
            </nav>

            <!-- Logout -->
            <div class="p-4 border-t border-gray-200">
                <button id="logoutBtn" class="w-full flex items-center justify-center space-x-2 px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span>D√©connexion</span>
                </button>
            </div>
        </aside>

        <!-- Main content -->
        <main class="flex-1 overflow-auto">
            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="tab-content active p-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">Tableau de bord</h1>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <!-- Devis Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Devis</p>
                                <p id="totalQuotes" class="text-2xl font-semibold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Clients Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Clients</p>
                                <p id="totalClients" class="text-2xl font-semibold text-gray-900">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- CA Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">Chiffre d'affaires</p>
                                <p id="totalCA" class="text-2xl font-semibold text-gray-900">0 ‚Ç¨</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- B√©n√©fice Card -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600 uppercase tracking-wide">B√©n√©fice</p>
                                <p id="totalBenefit" class="text-2xl font-semibold text-gray-900">0 ‚Ç¨</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quotes Tab -->
            <div id="quotesTab" class="tab-content p-6">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-900">Devis</h1>
                    <button id="createQuoteBtn" class="bg-white hover:bg-gray-50 text-black border-2 border-gray-300 px-4 py-2 rounded-lg font-medium transition-colors flex items-center space-x-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        <span>Nouveau Devis</span>
                    </button>
                </div>

                <!-- Quotes List -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Liste des devis</h3>
                        <div id="quotesList" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">
                                <p>Aucun devis cr√©√© pour le moment.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Clients Tab -->
            <div id="clientsTab" class="tab-content p-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">Clients</h1>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="p-6">
                        <p class="text-gray-500">Section clients en construction...</p>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content p-6">
                <h1 class="text-2xl font-bold text-gray-900 mb-6">Param√®tres</h1>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200">
                    <div class="p-6">
                        <p class="text-gray-500">Section param√®tres en construction...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Vue Cr√©ation de Devis - LAYOUT √âQUILIBR√â -->
    <div id="newQuoteView" class="hidden" style="position: fixed !important; top: 0 !important; left: 0 !important; right: 0 !important; bottom: 0 !important; width: 100vw !important; height: 100vh !important; background-color: #f8fafc !important; z-index: 9999 !important; overflow-y: auto !important;">
        <div style="min-height: 100vh !important; width: 100% !important; padding: 1rem; max-width: 1100px; margin: 0 auto;">
            <!-- Header simplifi√© - TEXTE PUR SANS CONTENANTS CLIQUABLES -->
            <div class="flex items-center justify-between mb-4 bg-white rounded-lg shadow-sm p-3 border">
                <div class="flex items-center space-x-4">
                    <div id="backToQuotesBtn" style="cursor: pointer; padding: 8px 12px; background: #f3f4f6; border-radius: 6px;">‚Üê Retour</div>
                    <div style="font-size: 1.25rem; font-weight: bold; color: #111827; pointer-events: none; user-select: none;">Nouveau Devis</div>
                </div>
                <button id="saveQuoteBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                    Enregistrer
                </button>
            </div>

            <!-- Formulaire √©quilibr√© -->
            <div class="bg-white rounded-lg shadow-sm border">
                <div class="p-4">
                    <form id="newQuoteForm" class="space-y-5">
                        <!-- Informations client - Layout √©quilibr√© -->
                        <div class="space-y-3">
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div>
                                    <label for="clientName" class="block text-sm font-medium text-gray-700 mb-1">Client *</label>
                                    <input type="text" id="clientName" name="clientName" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                                <div>
                                    <label for="clientEmail" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                                    <input type="email" id="clientEmail" name="clientEmail" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                                <div>
                                    <label for="clientPhone" class="block text-sm font-medium text-gray-700 mb-1">T√©l√©phone</label>
                                    <input type="tel" id="clientPhone" name="clientPhone" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                                <div>
                                    <label for="quoteDate" class="block text-sm font-medium text-gray-700 mb-1">Date *</label>
                                    <input type="date" id="quoteDate" name="quoteDate" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                                </div>
                            </div>
                            <div>
                                <label for="clientAddress" class="block text-sm font-medium text-gray-700 mb-1">Adresse du client</label>
                                <textarea id="clientAddress" name="clientAddress" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                            </div>
                        </div>

                        <!-- Section prestations simplifi√©e - TEXTE PUR SANS CONTENANTS CLIQUABLES -->
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div style="font-size: 1.125rem; font-weight: 600; color: #1f2937; display: flex; align-items: center; pointer-events: none; user-select: none;">
                                    <svg style="width: 1.25rem; height: 1.25rem; margin-right: 0.5rem; color: #2563eb; pointer-events: none;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                    </svg>
                                    <div style="pointer-events: none; user-select: none;">Prestations</div>
                                </div>
                                <button type="button" id="addServiceBtn" class="bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white px-4 py-2 rounded-lg flex items-center gap-2 text-sm font-medium transition-all duration-200 shadow-md hover:shadow-lg transform hover:scale-105">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Ajouter une prestation
                                </button>
                            </div>
                            <!-- Section prestations avec design en ligne -->
                            <div id="servicesContainerFullPage" class="space-y-3">
                                <div class="flex items-center gap-3 p-3 bg-white rounded-lg border shadow-sm">
                                    <div class="flex-1">
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Description de la prestation</label>
                                        <input type="text" name="service_description[]" placeholder="D√©crivez votre prestation..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" required>
                                    </div>
                                    <div class="w-16">
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Quantit√©</label>
                                        <input type="number" name="service_quantity[]" min="1" value="1" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm text-center" required>
                                    </div>
                                    <div class="w-28">
                                        <label class="block text-xs font-medium text-gray-600 mb-1">Prix HT</label>
                                        <input type="number" name="service_price[]" step="0.01" min="0" placeholder="0.00 ‚Ç¨" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm text-right" required>
                                    </div>
                                    <div class="flex items-end">
                                        <button type="button" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors" onclick="this.closest('.flex.items-center').remove(); updateTotal();" title="Supprimer cette prestation">
                                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                            </svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Layout 2 colonnes: Notes √† gauche, Total √† droite -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Notes (colonne gauche) -->
                            <div class="space-y-4">
                                <div>
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="block text-sm font-medium text-gray-700">Notes et conditions</label>
                                        <button type="button" id="addServiceBtnNotes" class="inline-flex items-center px-3 py-1 text-sm text-black hover:text-gray-600 transition-colors">
                                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                                            </svg>
                                            Ajouter une prestation
                                        </button>
                                    </div>
                                    <textarea name="quote_notes" rows="4" placeholder="Ajouter des notes ou conditions particuli√®res..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"></textarea>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Date d'√©ch√©ance</label>
                                        <input type="date" name="quote_due_date" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Validit√© (jours)</label>
                                        <input type="number" name="quote_validity" value="30" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                </div>
                            </div>

                            <!-- R√©capitulatif des totaux (colonne droite) -->
                            <div class="bg-gray-50 p-6 rounded-lg border">
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">R√©capitulatif</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between text-sm">
                                        <span class="text-gray-600">Sous-total HT</span>
                                        <span id="subtotalHT" class="font-medium">0,00 ‚Ç¨</span>
                                    </div>
                                    <div class="flex justify-between items-center text-sm">
                                        <span class="text-gray-600">TVA</span>
                                        <div class="flex items-center gap-2">
                                            <select name="quote_tax_rate" id="taxRateSelect" class="px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500" onchange="updateTotal()">
                                                <option value="20">20%</option>
                                                <option value="10">10%</option>
                                                <option value="5.5">5.5%</option>
                                                <option value="0">0%</option>
                                            </select>
                                            <span id="taxAmount" class="font-medium">0,00 ‚Ç¨</span>
                                        </div>
                                    </div>
                                    <div class="border-t pt-3">
                                        <div class="flex justify-between text-lg font-semibold text-gray-900">
                                            <span>Total TTC</span>
                                            <span id="totalTTC" class="text-blue-600">0,00 ‚Ç¨</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Boutons d'action -->
                        <div class="flex justify-end items-center pt-6 border-t">
                            <button type="button" id="saveQuoteBtnMain" class="inline-flex items-center px-6 py-2 bg-white hover:bg-gray-50 text-black text-sm font-medium rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors shadow-sm">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                                </svg>
                                Enregistrer et g√©n√©rer PDF
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>>

    <!-- ANCIENNE MODAL SUPPRIM√âE - UTILISATION UNIQUEMENT DE LA VUE PLEIN √âCRAN -->
    <!-- La modal quoteModal a √©t√© compl√®tement supprim√©e pour √©viter les conflits avec la vue plein √©cran -->

    <!-- Scripts -->
    <!-- Scripts -->
    
    <!-- Premier test de log IMM√âDIAT AVANT TOUT -->
    <script>
        console.log('üî•üî•üî•üî•üî• PREMIER SCRIPT DIRECT CHARG√â DANS LA FEN√äTRE PRINCIPALE üî•üî•üî•üî•üî•');
        
        // Tests de base
        console.log('window.location:', window.location.href);
        console.log('document.title:', document.title);
        console.log('Heure:', new Date().toISOString());
        
        // Alerter pour √™tre s√ªr que quelque chose s'ex√©cute
        setTimeout(() => {
            console.log('üö® SCRIPT DIRECT TOUJOURS EN VIE APR√àS 1 SECONDE');
        }, 1000);
    </script>
    
    <script src="js/jspdf.min.js"></script>
    <script>
        // V√©rification imm√©diate de jsPDF apr√®s chargement
        window.addEventListener('load', function() {
            console.log('üîç V√©rification jsPDF apr√®s chargement de la page...');
            if (window.jspdf && window.jspdf.jsPDF) {
                console.log('‚úÖ jsPDF disponible via window.jspdf.jsPDF');
                window.jsPDFReady = true;
            } else if (window.jsPDF) {
                console.log('‚úÖ jsPDF disponible via window.jsPDF');
                window.jsPDFReady = true;
            } else {
                console.error('‚ùå jsPDF non charg√© correctement');
                window.jsPDFReady = false;
            }
        });
    </script>
    <script src="js/supabase.min.js"></script>
    <script src="services/auth.js"></script>
    <script src="services/database.js"></script>
    <script src="js/init.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        // DEBUG: V√©rifier l'√©tat des services au chargement
        console.log('üî•üî•üî• [MAIN WINDOW] SCRIPT EX√âCUT√â - D√âBUT V√âRIFICATIONS üî•üî•üî•');
        
        // Fonction d'attente pour les services
        async function waitForServices() {
            console.log('‚è∞ [MAIN WINDOW] Attente des services...');
            
            // Attendre que les services soient disponibles
            let attempts = 0;
            const maxAttempts = 50;
            
            while (attempts < maxAttempts) {
                if (window.dbService && window.authService) {
                    console.log('‚úÖ [MAIN WINDOW] Services trouv√©s!');
                    console.log('üîç window.dbService:', !!window.dbService);
                    console.log('üîç window.dbService type:', typeof window.dbService);
                    if (window.dbService) {
                        console.log('üîç dbService.createQuote existe:', typeof window.dbService.createQuote);
                        console.log('üîç dbService methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(window.dbService)));
                    }
                    console.log('üîç window.authService existe:', !!window.authService);
                    console.log('üîç window.authService type:', typeof window.authService);
                    return true;
                }
                
                console.log(`‚è∞ [MAIN WINDOW] Tentative ${attempts + 1}/${maxAttempts} - Services non disponibles`);
                attempts++;
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.error('‚ùå [MAIN WINDOW] √âchec de l\\\'attente des services');
            return false;
        }
        
        // === FONCTIONS GLOBALES POUR LES ACTIONS SUR LES DEVIS - D√âFINIES TR√àS T√îT ===
        
        console.log('üî• [DEBUG] D√©finition des fonctions globales...');
        
        // Fonction pour afficher la vue cr√©ation/modification de devis
        window.showNewQuoteView = function() {
            console.log('üìù Ouverture de la vue cr√©ation de devis');
            
            // Afficher la vue cr√©ation de devis en plein √©cran
            const newQuoteView = document.getElementById('newQuoteView');
            if (newQuoteView) {
                console.log('‚úÖ Vue newQuoteView trouv√©e, ouverture...');
                newQuoteView.classList.remove('hidden');
                
                // FORCER LES STYLES POUR PRENDRE TOUT L'√âCRAN
                newQuoteView.style.position = 'fixed';
                newQuoteView.style.top = '0';
                newQuoteView.style.left = '0';
                newQuoteView.style.right = '0';
                newQuoteView.style.bottom = '0';
                newQuoteView.style.width = '100vw';
                newQuoteView.style.height = '100vh';
                newQuoteView.style.zIndex = '9999';
                newQuoteView.style.backgroundColor = '#f3f4f6';
                newQuoteView.style.display = 'block !important';
                console.log('üîß Vue forc√©e en plein √©cran avec styles JavaScript');
            } else {
                console.error('‚ùå Vue newQuoteView non trouv√©e !');
            }
        };
        
        window.editQuote = async function(quoteId) {
            console.log('‚úèÔ∏è [QUOTES] Modification du devis:', quoteId);
            
            try {
                if (!window.dbService) {
                    console.error('‚ùå Service de base de donn√©es non disponible');
                    alert('Erreur - Service de base de donn√©es non disponible');
                    return;
                }
                
                // R√©cup√©rer les donn√©es du devis
                const quote = await window.dbService.getQuoteById(quoteId);
                if (!quote) {
                    alert('Devis non trouv√©');
                    return;
                }
                
                console.log('üìã Chargement du devis pour modification:', quote);
                
                // Charger les donn√©es dans le formulaire
                loadQuoteInForm(quote);
                
                // Basculer vers la vue de cr√©ation/modification 
                showNewQuoteView();
                
            } catch (error) {
                console.error('‚ùå [QUOTES] Erreur lors de la modification:', error);
                alert('Erreur lors du chargement du devis pour modification');
            }
        }

        window.generateQuotePDF = async function(quoteId) {
            console.log('üìÑ [QUOTES] G√©n√©ration PDF pour le devis:', quoteId);
            
            try {
                if (!window.dbService) {
                    console.error('‚ùå Service de base de donn√©es non disponible');
                    alert('Erreur - Service de base de donn√©es non disponible');
                    return;
                }
                
                // R√©cup√©rer les d√©tails du devis
                const quote = await window.dbService.getQuoteById(quoteId);
                if (!quote) {
                    alert('Devis non trouv√©');
                    return;
                }
                
                console.log('üìÑ [PDF] G√©n√©ration PDF √† partir du devis:', quote);
                
                // Appeler la m√™me fonction de g√©n√©ration PDF que pour les nouveaux devis
                await generateAndDownloadPDF({
                    clientName: quote.client_name || '',
                    clientEmail: quote.client_email || '',
                    clientPhone: quote.client_phone || '',
                    clientAddress: quote.client_address || '',
                    quoteDate: quote.quote_date || new Date().toISOString().split('T')[0],
                    notes: quote.notes || '',
                    services: quote.services || [],
                    totalHT: quote.total_ht || 0,
                    totalTVA: quote.total_tva || 0,
                    totalTTC: quote.total_ttc || 0,
                    quoteNumber: quote.quote_number || `DEV-${Date.now()}`
                });
                
            } catch (error) {
                console.error('‚ùå [QUOTES] Erreur lors de la g√©n√©ration PDF:', error);
                alert('Erreur lors de la g√©n√©ration du PDF');
            }
        }

        window.deleteQuote = async function(quoteId) {
            console.log('üóëÔ∏è [QUOTES] Suppression du devis:', quoteId);
            
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce devis ?')) {
                return;
            }
            
            try {
                if (!window.dbService) {
                    console.error('‚ùå Service de base de donn√©es non disponible');
                    alert('Erreur - Service de base de donn√©es non disponible');
                    return;
                }
                
                // Supprimer le devis
                await window.dbService.deleteQuote(quoteId);
                
                alert('Devis supprim√© avec succ√®s');
                
                // Recharger la liste
                if (typeof window.loadQuotesList === 'function') {
                    window.loadQuotesList();
                } else {
                    // Recharger la page si la fonction n'est pas disponible
                    location.reload();
                }
                
            } catch (error) {
                console.error('‚ùå [QUOTES] Erreur lors de la suppression:', error);
                alert('Erreur lors de la suppression du devis');
            }
        }

        window.loadQuotesList = async function() {
            console.log('üìã [QUOTES] Chargement de la liste des devis...');
            
            try {
                if (!window.dbService) {
                    console.error('‚ùå [QUOTES] Service de base de donn√©es non disponible');
                    return;
                }
                
                const quotes = await window.dbService.getQuotes();
                console.log('üìã [QUOTES] Devis r√©cup√©r√©s:', quotes);
                
                const container = document.getElementById('quotes-container');
                if (!container) {
                    console.error('‚ùå [QUOTES] Container non trouv√©');
                    return;
                }
                
                if (!quotes || quotes.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-gray-500">Aucun devis trouv√©</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = quotes.map(quote => `
                    <div class="bg-white rounded-lg shadow-md p-6 border border-gray-200">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">${quote.quote_number || 'N/A'}</h3>
                                <p class="text-gray-600">${quote.client_name || 'N/A'}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-lg font-semibold text-gray-900">${(quote.total_ttc || 0).toFixed(2)} ‚Ç¨</p>
                                <p class="text-sm text-gray-500">${quote.quote_date || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-2 pt-4 border-t border-gray-100">
                            <button onclick="editQuote('${quote.id}')" class="px-3 py-1 text-sm text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded">
                                Modifier
                            </button>
                            <button onclick="deleteQuote('${quote.id}')" class="px-3 py-1 text-sm text-red-600 hover:text-red-800 hover:bg-red-50 rounded">
                                Supprimer
                            </button>
                            <button onclick="generateQuotePDF('${quote.id}')" class="px-3 py-1 text-sm text-green-600 hover:text-green-800 hover:bg-green-50 rounded">
                                PDF
                            </button>
                        </div>
                    </div>
                `).join('');
                
                console.log(`‚úÖ [QUOTES] ${quotes.length} devis affich√©s`);
                
            } catch (error) {
                console.error('‚ùå [QUOTES] Erreur lors du chargement des devis:', error);
                const container = document.getElementById('quotes-container');
                if (container) {
                    container.innerHTML = `
                        <div class="text-center py-8">
                            <p class="text-red-500">Erreur lors du chargement des devis</p>
                        </div>
                    `;
                }
            }
        }
        
        // === FIN D√âFINITIONS FONCTIONS GLOBALES ===
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìù [MAIN WINDOW] DOM CHARG√â - Attente services...');
            
            const servicesReady = await waitForServices();
            if (servicesReady) {
                console.log('üéâ [MAIN WINDOW] Services pr√™ts - Initialisation application');
                
                // Charger les donn√©es initiales
                setTimeout(async () => {
                    console.log('üîÑ [INIT] Chargement des donn√©es initiales...');
                    
                    // Si l'onglet devis est visible (ou sera visible bient√¥t), charger les devis
                    // Attendre un peu que tout soit initialis√©
                    try {
                        await window.loadQuotesList();
                        console.log('‚úÖ [INIT] Donn√©es des devis charg√©es');
                    } catch (error) {
                        console.error('‚ùå [INIT] Erreur lors du chargement initial des devis:', error);
                    }
                }, 1000);
                
            } else {
                console.error('üí• [MAIN WINDOW] Services non disponibles - Mode d√©grad√©');
            }
        });
    </script>
    
    <script>
        // ==========================================
        // FONCTION DE TEST SIMPLE (disponible imm√©diatement)
        // ==========================================
        window.testSaveFunction = function() {
            alert('üî• TEST - La fonction JavaScript fonctionne !');
            console.log('üî• TEST: Bouton de test cliqu√© !');
            
            // Test de collecte des donn√©es du formulaire
            const form = document.getElementById('newQuoteForm');
            if (!form) {
                alert('‚ùå ERREUR - Formulaire non trouv√©');
                return;
            }
            
            console.log('‚úÖ Formulaire trouv√©:', form);
            
            // Test de collecte des services
            const services = document.querySelectorAll('#servicesContainerFullPage > div');
            console.log('üìä Services trouv√©s:', services.length);
            
            if (services.length === 0) {
                alert('‚ö†Ô∏è Aucune ligne de service trouv√©e. Ajoutez une prestation d\\\'abord !');
                return;
            }
            
            // Collecter les donn√©es du premier service
            const firstService = services[0];
            const description = firstService.querySelector('textarea[name="service_description[]"]')?.value || firstService.querySelector('input[name="service_description[]"]')?.value;
            const quantity = firstService.querySelector('input[name="service_quantity[]"]')?.value;
            const price = firstService.querySelector('input[name="service_price[]"]')?.value;
            
            console.log('üìä Premier service:', {description, quantity, price});
            
            if (!description || !quantity || !price) {
                alert('‚ö†Ô∏è Veuillez remplir au moins une prestation compl√®te (description, quantit√©, prix)');
                return;
            }
            
            alert(`‚úÖ Test r√©ussi ! Service trouv√©: "${description}" - Qt√©: ${quantity} - Prix: ${price}‚Ç¨`);
            
            // Maintenant essayer la vraie sauvegarde
            if (confirm('Voulez-vous essayer de sauvegarder ce devis ?')) {
                // Appeler la fonction r√©elle de sauvegarde
                if (window.handleSaveQuote) {
                    const btn = document.getElementById('saveQuoteBtnMain');
                    window.handleSaveQuote(btn);
                } else {
                    alert('‚ùå Fonction de sauvegarde non trouv√©e');
                }
            }
        };
        
        // Navigation functionality
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ [MAIN WINDOW] Initialisation de la navigation...');
            
            // ==========================================
            // FONCTION DE FERMETURE ABSOLUE NOUVEAU DEVIS - VERSION RADICALE
            // ==========================================
            function closeNewQuoteViewCompletely() {
                console.log('üö´ FERMETURE ABSOLUE - Nouveau Devis - VERSION RADICALE');
                
                // 1. Masquer la vue avec toutes les m√©thodes possibles
                const newQuoteView = document.getElementById('newQuoteView');
                if (newQuoteView) {
                    newQuoteView.classList.add('hidden');
                    newQuoteView.style.display = 'none !important';
                    newQuoteView.style.visibility = 'hidden !important';
                    newQuoteView.style.opacity = '0 !important';
                    newQuoteView.style.zIndex = '-9999 !important';
                    newQuoteView.style.position = 'absolute !important';
                    newQuoteView.style.left = '-9999px !important';
                    newQuoteView.style.top = '-9999px !important';
                    newQuoteView.style.width = '0 !important';
                    newQuoteView.style.height = '0 !important';
                    newQuoteView.style.overflow = 'hidden !important';
                    newQuoteView.style.pointerEvents = 'none !important';
                    console.log('‚úÖ Vue nouveau devis BRUTALEMENT masqu√©e');
                }
                
                // 2. FORCER la fermeture de tout onglet qui pourrait exister
                try {
                    // Fermer tous les onglets potentiels dans l'historique
                    if (window.history && window.history.length > 1) {
                        console.log('üîÑ Nettoyage historique navigateur');
                        window.history.back();
                        setTimeout(() => {
                            window.history.forward();
                        }, 10);
                    }
                } catch(e) {
                    console.log('‚ö†Ô∏è Pas d\\\'historique √† nettoyer');
                }
                
                // 3. R√©initialiser TOUS les onglets de l'application
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // 4. D√©sactiver TOUS les sidebar items
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // 5. FORCER l'activation de l'onglet DEVIS avec d√©lai
                setTimeout(() => {
                    const quotesTab = document.getElementById('quotesTab');
                    const quotesSidebarItem = document.querySelector('[data-tab="quotes"]');
                    
                    if (quotesTab) {
                        quotesTab.classList.add('active');
                        quotesTab.style.display = 'block !important';
                        quotesTab.style.visibility = 'visible !important';
                        quotesTab.style.opacity = '1 !important';
                        console.log('‚úÖ Onglet DEVIS FORC√â');
                    }
                    
                    if (quotesSidebarItem) {
                        quotesSidebarItem.classList.add('active');
                        console.log('‚úÖ Sidebar DEVIS FORC√â');
                    }
                }, 50);
                
                // 6. Emp√™cher tout √©v√©nement sur newQuoteView
                if (newQuoteView) {
                    newQuoteView.onclick = null;
                    newQuoteView.onmousedown = null;
                    newQuoteView.onmouseup = null;
                    newQuoteView.onmousemove = null;
                }
                
                console.log('üéØ FERMETURE RADICALE TERMIN√âE');
            }

            // Fonction pour charger les devis
            async function loadQuotesList() {
                console.log('üìã [QUOTES] Chargement de la liste des devis...');
                
                try {
                    if (!window.dbService) {
                        console.error('‚ùå [QUOTES] Service de base de donn√©es non disponible');
                        return;
                    }
                    
                    const quotes = await window.dbService.getQuotes();
                    console.log('üìã [QUOTES] Devis r√©cup√©r√©s:', quotes);
                    
                    const quotesListContainer = document.getElementById('quotesList');
                    if (!quotesListContainer) {
                        console.error('‚ùå [QUOTES] Container quotesList non trouv√©');
                        return;
                    }
                    
                    if (!quotes || quotes.length === 0) {
                        quotesListContainer.innerHTML = `
                            <div class="text-center py-8 text-gray-500">
                                <p>Aucun devis cr√©√© pour le moment.</p>
                            </div>
                        `;
                        return;
                    }
                    
                    // G√©n√©rer le HTML des devis
                    const quotesHTML = quotes.map(quote => {
                        const date = new Date(quote.quote_date || quote.created_at).toLocaleDateString('fr-FR');
                        const status = quote.status || 'draft';
                        const statusColor = status === 'sent' ? 'bg-blue-100 text-blue-800' : 
                                          status === 'accepted' ? 'bg-green-100 text-green-800' : 
                                          status === 'rejected' ? 'bg-red-100 text-red-800' :
                                          'bg-gray-100 text-gray-800';
                        
                        return `
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center gap-3">
                                            <h4 class="font-medium text-gray-900">${quote.quote_number || 'N/A'}</h4>
                                            <span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">
                                                ${status === 'draft' ? 'Brouillon' : status === 'sent' ? 'Envoy√©' : status === 'accepted' ? 'Accept√©' : status === 'rejected' ? 'Refus√©' : status}
                                            </span>
                                        </div>
                                        <div class="text-sm text-gray-500 mt-1">
                                            ${date} ‚Ä¢ ${quote.total_ttc || quote.subtotal_ht || 0}‚Ç¨ TTC
                                        </div>
                                        ${quote.notes ? `<div class="text-sm text-gray-600 mt-2">${quote.notes}</div>` : ''}
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <button onclick="editQuote('${quote.id}')" class="px-3 py-1 text-sm text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded">
                                            Modifier
                                        </button>
                                        <button onclick="generateQuotePDF('${quote.id}')" class="px-3 py-1 text-sm text-green-600 hover:text-green-800 hover:bg-green-50 rounded">
                                            PDF
                                        </button>
                                        <button onclick="deleteQuote('${quote.id}')" class="px-3 py-1 text-sm text-red-600 hover:text-red-800 hover:bg-red-50 rounded">
                                            Supprimer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    quotesListContainer.innerHTML = quotesHTML;
                    console.log(`‚úÖ [QUOTES] ${quotes.length} devis affich√©s`);
                    
                } catch (error) {
                    console.error('‚ùå [QUOTES] Erreur lors du chargement des devis:', error);
                    const quotesListContainer = document.getElementById('quotesList');
                    if (quotesListContainer) {
                        quotesListContainer.innerHTML = `
                            <div class="text-center py-8 text-red-500">
                                <p>Erreur lors du chargement des devis.</p>
                            </div>
                        `;
                    }
                }
            }

            // Fonction pour ajouter une prestation dans le formulaire
            function addService(description = '', quantity = 1, unitPrice = 0) {
                console.log('‚ûï [FORM] Ajout d\\\'une prestation:', { description, quantity, unitPrice });
                
                const container = document.getElementById('servicesContainerFullPage');
                if (!container) {
                    console.error('‚ùå Container servicesContainerFullPage non trouv√©');
                    return;
                }
                
                // Cr√©er le HTML de la nouvelle prestation
                const serviceHTML = `
                    <div class="flex items-center gap-3 p-3 bg-white rounded-lg border shadow-sm">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Description de la prestation</label>
                            <input type="text" name="service_description[]" value="${description}" placeholder="D√©crivez votre prestation..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" required>
                        </div>
                        <div class="w-16">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Quantit√©</label>
                            <input type="number" name="service_quantity[]" value="${quantity}" min="1" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm text-center" required>
                        </div>
                        <div class="w-28">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Prix HT</label>
                            <input type="number" name="service_price[]" value="${unitPrice}" step="0.01" min="0" placeholder="0.00 ‚Ç¨" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm text-right" required>
                        </div>
                        <div class="flex items-end">
                            <button type="button" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors" onclick="this.closest('.flex.items-center').remove(); updateTotal();" title="Supprimer cette prestation">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                
                // Ajouter la prestation au container
                container.insertAdjacentHTML('beforeend', serviceHTML);
                
                console.log('‚úÖ [FORM] Prestation ajout√©e');
                
                // Mettre √† jour le total (si la fonction existe)
                if (typeof updateTotal === 'function') {
                    updateTotal();
                }
            }

            // Fonction pour charger un devis dans le formulaire
            window.loadQuoteInForm = async function loadQuoteInForm(quote) {
                console.log('üìã [FORM] Chargement du devis dans le formulaire:', quote);
                
                try {
                    // Remplir les champs de base
                    const form = document.getElementById('newQuoteForm');
                    if (!form) {
                        console.error('‚ùå [FORM] Formulaire newQuoteForm non trouv√©');
                        return;
                    }
                    
                    // Informations client - DEBUG des valeurs
                    console.log('üìã [FORM] Valeurs client √† charger:', {
                        client_name: quote.client_name,
                        client_email: quote.client_email,
                        client_phone: quote.client_phone,
                        client_address: quote.client_address
                    });
                    
                    const clientName = form.querySelector('#clientName') || form.querySelector('input[name="clientName"]');
                    if (clientName) {
                        clientName.value = quote.client_name || '';
                        console.log('üìã [FORM] Client name d√©fini:', clientName.value);
                    } else {
                        console.warn('‚ö†Ô∏è [FORM] Champ clientName non trouv√©');
                    }
                    
                    const clientEmail = form.querySelector('#clientEmail') || form.querySelector('input[name="clientEmail"]');
                    if (clientEmail) {
                        clientEmail.value = quote.client_email || '';
                        console.log('üìã [FORM] Client email d√©fini:', clientEmail.value);
                    } else {
                        console.warn('‚ö†Ô∏è [FORM] Champ clientEmail non trouv√©');
                    }
                    
                    const clientPhone = form.querySelector('#clientPhone') || form.querySelector('input[name="clientPhone"]');
                    if (clientPhone) {
                        clientPhone.value = quote.client_phone || '';
                        console.log('üìã [FORM] Client phone d√©fini:', clientPhone.value);
                    } else {
                        console.warn('‚ö†Ô∏è [FORM] Champ clientPhone non trouv√©');
                    }
                    
                    const clientAddress = form.querySelector('#clientAddress') || form.querySelector('textarea[name="clientAddress"]');
                    if (clientAddress) {
                        clientAddress.value = quote.client_address || '';
                        console.log('üìã [FORM] Client address d√©fini:', clientAddress.value);
                    } else {
                        console.warn('‚ö†Ô∏è [FORM] Champ clientAddress non trouv√©');
                    }
                    
                    // Date
                    const quoteDate = form.querySelector('#quoteDate') || form.querySelector('input[name="quoteDate"]');
                    if (quoteDate && quote.quote_date) {
                        const date = new Date(quote.quote_date);
                        quoteDate.value = date.toISOString().split('T')[0];
                        console.log('üìã [FORM] Date d√©finie:', quoteDate.value);
                    }
                    
                    // Notes - CORRECTION du s√©lecteur
                    const notes = form.querySelector('#quoteNotes') || form.querySelector('textarea[name="quoteNotes"]');
                    if (notes) {
                        notes.value = quote.notes || '';
                        console.log('üìã [FORM] Notes d√©finies:', notes.value);
                    } else {
                        console.warn('‚ö†Ô∏è [FORM] Champ notes non trouv√©');
                    }
                    
                    // Charger les prestations si disponibles - CORRECTION du s√©lecteur
                    if (quote.services && Array.isArray(quote.services) && quote.services.length > 0) {
                        console.log('üìã [FORM] Chargement de', quote.services.length, 'prestations');
                        
                        const servicesContainer = document.getElementById('servicesContainerFullPage');
                        if (servicesContainer) {
                            // Vider les prestations existantes sauf la premi√®re (template)
                            const services = servicesContainer.querySelectorAll('> div');
                            services.forEach((service, index) => {
                                if (index > 0) service.remove();
                            });
                            
                            // Remplir la premi√®re prestation et ajouter les autres
                            quote.services.forEach((service, index) => {
                                if (index === 0) {
                                    // Modifier la premi√®re prestation existante
                                    const firstService = servicesContainer.querySelector('> div');
                                    if (firstService) {
                                        const desc = firstService.querySelector('input[name="service_description[]"]');
                                        const qty = firstService.querySelector('input[name="service_quantity[]"]');
                                        const price = firstService.querySelector('input[name="service_price[]"]');
                                        
                                        if (desc) desc.value = service.description || '';
                                        if (qty) qty.value = service.quantity || 1;
                                        if (price) price.value = service.price || 0;
                                    }
                                } else {
                                    // Ajouter une nouvelle prestation
                                    addService(service.description || '', service.quantity || 1, service.price || 0);
                                }
                            });
                            
                            console.log('‚úÖ [FORM] Prestations charg√©es');
                        } else {
                            console.error('‚ùå [FORM] Container servicesContainerFullPage non trouv√©');
                        }
                    } else {
                        console.log('‚ÑπÔ∏è [FORM] Aucune prestation √† charger');
                    }
                    
                    console.log('‚úÖ [FORM] Devis charg√© dans le formulaire');
                    
                } catch (error) {
                    console.error('‚ùå [FORM] Erreur lors du chargement du devis:', error);
                }
            }

            // Fonction pour g√©n√©rer un PDF √† partir d'un devis existant
            async function generatePDFFromQuote(quote) {
                console.log('üìÑ [PDF] G√©n√©ration PDF √† partir du devis:', quote);
                
                try {
                    if (!window.jsPDF) {
                        console.error('‚ùå jsPDF non disponible');
                        alert('Erreur - jsPDF non disponible');
                        return;
                    }
                    
                    const { jsPDF } = window.jsPDF;
                    const doc = new jsPDF();
                    
                    // Configuration
                    const margin = 20;
                    const pageWidth = doc.internal.pageSize.getWidth();
                    const pageHeight = doc.internal.pageSize.getHeight();
                    
                    // Titre
                    doc.setFontSize(20);
                    doc.setFont(undefined, 'bold');
                    doc.text('DEVIS', pageWidth / 2, margin, { align: 'center' });
                    
                    // Num√©ro de devis et date
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    let yPosition = margin + 15;
                    
                    if (quote.quote_number) {
                        doc.text(`Num√©ro: ${quote.quote_number}`, margin, yPosition);
                        yPosition += 5;
                    }
                    
                    if (quote.quote_date) {
                        const date = new Date(quote.quote_date).toLocaleDateString('fr-FR');
                        doc.text(`Date: ${date}`, margin, yPosition);
                        yPosition += 10;
                    }
                    
                    // Informations client
                    if (quote.client_name) {
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('Client:', margin, yPosition);
                        yPosition += 7;
                        
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        doc.text(quote.client_name, margin, yPosition);
                        yPosition += 5;
                        
                        if (quote.client_email) {
                            doc.text(quote.client_email, margin, yPosition);
                            yPosition += 5;
                        }
                        
                        if (quote.client_phone) {
                            doc.text(quote.client_phone, margin, yPosition);
                            yPosition += 5;
                        }
                        
                        if (quote.client_address) {
                            const addressLines = doc.splitTextToSize(quote.client_address, pageWidth - 2 * margin);
                            doc.text(addressLines, margin, yPosition);
                            yPosition += addressLines.length * 5;
                        }
                        
                        yPosition += 10;
                    }
                    
                    // Prestations
                    if (quote.services && Array.isArray(quote.services) && quote.services.length > 0) {
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('Prestations:', margin, yPosition);
                        yPosition += 10;
                        
                        // En-t√™tes du tableau
                        doc.setFontSize(10);
                        doc.text('Description', margin, yPosition);
                        doc.text('Qt√©', pageWidth - 100, yPosition);
                        doc.text('P.U.', pageWidth - 70, yPosition);
                        doc.text('Total', pageWidth - 40, yPosition);
                        yPosition += 7;
                        
                        // Ligne de s√©paration
                        doc.line(margin, yPosition, pageWidth - margin, yPosition);
                        yPosition += 5;
                        
                        // Prestations
                        doc.setFont(undefined, 'normal');
                        quote.services.forEach(service => {
                            const description = service.description || 'Service';
                            const quantity = service.quantity || 1;
                            const unitPrice = service.unit_price || 0;
                            const total = quantity * unitPrice;
                            
                            doc.text(description.substring(0, 40), margin, yPosition);
                            doc.text(quantity.toString(), pageWidth - 100, yPosition);
                            doc.text(`${unitPrice.toFixed(2)}‚Ç¨`, pageWidth - 70, yPosition);
                            doc.text(`${total.toFixed(2)}‚Ç¨`, pageWidth - 40, yPosition);
                            yPosition += 7;
                        });
                        
                        yPosition += 10;
                    }
                    
                    // Totaux
                    if (quote.subtotal_ht || quote.total_ttc) {
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        
                        if (quote.subtotal_ht) {
                            doc.text(`Sous-total HT: ${parseFloat(quote.subtotal_ht).toFixed(2)}‚Ç¨`, pageWidth - 80, yPosition, { align: 'right' });
                            yPosition += 7;
                        }
                        
                        if (quote.total_ttc) {
                            doc.text(`Total TTC: ${parseFloat(quote.total_ttc).toFixed(2)}‚Ç¨`, pageWidth - 80, yPosition, { align: 'right' });
                            yPosition += 10;
                        }
                    }
                    
                    // Notes
                    if (quote.notes) {
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        doc.text('Notes:', margin, yPosition);
                        yPosition += 7;
                        
                        const notesLines = doc.splitTextToSize(quote.notes, pageWidth - 2 * margin);
                        doc.text(notesLines, margin, yPosition);
                    }
                    
                    // Sauvegarder le PDF
                    const fileName = `devis_${quote.quote_number || quote.id || 'export'}_${Date.now()}.pdf`;
                    doc.save(fileName);
                    
                    console.log('‚úÖ [PDF] PDF g√©n√©r√© avec succ√®s:', fileName);
                    
                } catch (error) {
                    console.error('‚ùå [PDF] Erreur lors de la g√©n√©ration PDF:', error);
                    alert('Erreur lors de la g√©n√©ration du PDF');
                }
            }

            // Tab switching functionality
            function switchTab(tabName) {
                console.log(`üîÑ [NAVIGATION] Switching to ${tabName} tab`);
                
                // SUPPRESSION IMM√âDIATE DES BOUTONS FANT√îMES LORS DU CHANGEMENT D'ONGLET
                console.log('üóëÔ∏è [TAB SWITCH] Nettoyage des boutons fant√¥mes lors du changement d\'onglet');
                removeAllGhostButtonsDefinitively();
                
                // FORCER LA FERMETURE de la vue nouveau devis si elle est ouverte
                const newQuoteView = document.getElementById('newQuoteView');
                if (newQuoteView && !newQuoteView.classList.contains('hidden')) {
                    console.log('üö´ Fermeture forc√©e de la vue nouveau devis');
                    // Fermer la vue nouveau devis
                    newQuoteView.classList.add('hidden');
                    newQuoteView.style.display = 'none !important';
                    newQuoteView.style.visibility = 'hidden !important';
                    newQuoteView.style.opacity = '0 !important';
                    newQuoteView.style.zIndex = '-9999 !important';
                    newQuoteView.style.position = 'absolute !important';
                    newQuoteView.style.left = '-9999px !important';
                    newQuoteView.style.top = '-9999px !important';
                }
                
                // Hide all tabs
                document.querySelectorAll('.tab-content').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                // Remove active from sidebar items
                document.querySelectorAll('.sidebar-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                // Show selected tab
                const targetTab = document.getElementById(tabName + 'Tab');
                if (targetTab) {
                    targetTab.classList.add('active');
                    console.log(`‚úÖ Onglet ${tabName} activ√©`);
                }
                
                // Add active to clicked sidebar item
                const sidebarItem = document.querySelector(`[data-tab="${tabName}"]`);
                if (sidebarItem) {
                    sidebarItem.classList.add('active');
                    console.log(`‚úÖ Sidebar ${tabName} activ√©`);
                }
                
                // NETTOYAGE SUPPL√âMENTAIRE apr√®s activation des onglets
                setTimeout(() => removeAllGhostButtonsDefinitively(), 100);
                
                // Charger les donn√©es sp√©cifiques √† l'onglet
                if (tabName === 'quotes') {
                    loadQuotesList();
                }
            }
            
            // Setup tab navigation
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tabName = e.currentTarget.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });
            
            // Window controls
            const minimizeBtn = document.getElementById('minimizeBtn');
            const maximizeBtn = document.getElementById('maximizeBtn');
            const closeBtn = document.getElementById('closeBtn');
            
            if (minimizeBtn) {
                minimizeBtn.addEventListener('click', () => {
                    if (window.electronAPI) window.electronAPI.minimizeWindow();
                });
            }
            
            if (maximizeBtn) {
                maximizeBtn.addEventListener('click', () => {
                    if (window.electronAPI) window.electronAPI.maximizeWindow();
                });
            }
            
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    if (window.electronAPI) window.electronAPI.closeWindow();
                });
            }
            
            // Logout button
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    console.log('üö™ [LOGOUT] D√©connexion...');
                    
                    if (window.authService && typeof window.authService.signOut === 'function') {
                        await window.authService.signOut();
                    }
                    
                    if (window.electronAPI && typeof window.electronAPI.showLogin === 'function') {
                        window.electronAPI.showLogin();
                    }
                });
            }
            
            console.log('‚úÖ [MAIN WINDOW] Navigation initialis√©e');
            
            // ==========================================
            // SUPPRESSION RADICALE DES BOUTONS INVISIBLES - VERSION D√âFINITIVE
            // ==========================================
            function removeAllGhostButtonsDefinitively() {
                console.log('üîç [GHOST REMOVAL] SUPPRESSION D√âFINITIVE des boutons invisibles - SCAN COMPLET');
                
                let removedCount = 0;
                
                // === M√âTHODE 1: Supprimer tous les boutons avec text-white sur fond blanc ===
                document.querySelectorAll('button.text-white, .text-white button, button[style*="color: white"], button[style*="color:#ffffff"], button[style*="color: #ffffff"]').forEach((btn, index) => {
                    const computedStyle = window.getComputedStyle(btn);
                    const bgColor = computedStyle.backgroundColor;
                    const color = computedStyle.color;
                    
                    // V√©rifier si c'est un bouton avec texte blanc sur fond blanc/transparent
                    if (
                        (color === 'rgb(255, 255, 255)' || color === '#ffffff' || color === 'white') &&
                        (bgColor === 'rgba(0, 0, 0, 0)' || bgColor === 'transparent' || bgColor === 'rgb(255, 255, 255)' || bgColor === '#ffffff' || bgColor === 'white')
                    ) {
                        console.log(`üóëÔ∏è [GHOST] Suppression bouton blanc-sur-blanc ${index + 1}:`, btn);
                        btn.remove();
                        removedCount++;
                    }
                });
                
                // === M√âTHODE 2: Supprimer les boutons invisibles (opacity 0, visibility hidden) ===
                document.querySelectorAll('button[style*="opacity: 0"], button[style*="opacity:0"], button[style*="visibility: hidden"], button[style*="visibility:hidden"]').forEach((btn, index) => {
                    console.log(`üóëÔ∏è [GHOST] Suppression bouton invisible ${index + 1}:`, btn);
                    btn.remove();
                    removedCount++;
                });
                
                // === M√âTHODE 3: Supprimer les boutons cach√©s par display:none ===
                document.querySelectorAll('button[style*="display: none"], button[style*="display:none"]').forEach((btn, index) => {
                    console.log(`üóëÔ∏è [GHOST] Suppression bouton cach√© ${index + 1}:`, btn);
                    btn.remove();
                    removedCount++;
                });
                
                // === M√âTHODE 4: Scanner les zones probl√©matiques sp√©cifiques ===
                const problematicZones = [
                    '#newQuoteView .flex.items-center.justify-between',
                    '.bg-white.rounded-lg.shadow-sm.border.border-gray-200 .flex.items-center.justify-between',
                    '[style*="Nouveau Devis"]',
                    '[style*="Prestations"]',
                    '.space-x-4',
                    '.gap-2'
                ];
                
                problematicZones.forEach(zone => {
                    const zoneElements = document.querySelectorAll(zone);
                    zoneElements.forEach(zoneEl => {
                        const buttons = zoneEl.querySelectorAll('button, [role="button"], .cursor-pointer');
                        buttons.forEach((btn, index) => {
                            const computedStyle = window.getComputedStyle(btn);
                            const isInvisible = (
                                computedStyle.opacity === '0' ||
                                computedStyle.visibility === 'hidden' ||
                                computedStyle.display === 'none' ||
                                (computedStyle.color === 'rgb(255, 255, 255)' && (computedStyle.backgroundColor === 'rgba(0, 0, 0, 0)' || computedStyle.backgroundColor === 'transparent'))
                            );
                            
                            if (isInvisible) {
                                console.log(`üóëÔ∏è [GHOST] Zone ${zone} - Suppression bouton fant√¥me ${index + 1}:`, btn);
                                btn.remove();
                                removedCount++;
                            }
                        });
                    });
                });
                
                // === M√âTHODE 5: V√©rifier les boutons par texte (si vide ou invisible) ===
                document.querySelectorAll('button').forEach((btn, index) => {
                    const text = btn.textContent.trim();
                    const innerHTML = btn.innerHTML.trim();
                    const computedStyle = window.getComputedStyle(btn);
                    
                    // Bouton sans contenu visible ET invisible
                    if (
                        (!text && !innerHTML) ||
                        (text === '' && innerHTML === '') ||
                        (computedStyle.opacity === '0' || computedStyle.visibility === 'hidden')
                    ) {
                        console.log(`üóëÔ∏è [GHOST] Suppression bouton vide/invisible ${index + 1}:`, btn);
                        btn.remove();
                        removedCount++;
                    }
                });
                
                console.log(`‚úÖ [GHOST REMOVAL] SUPPRESSION TERMIN√âE - ${removedCount} boutons fant√¥mes supprim√©s`);
                return removedCount;
            }
            
            // === SURVEILLANCE CONTINUE AVEC MUTATIONOBSERVER ===
            function setupGhostButtonMonitoring() {
                console.log('üëÅÔ∏è [GHOST MONITOR] D√©marrage surveillance continue des boutons fant√¥mes');
                
                const observer = new MutationObserver((mutations) => {
                    let needsScan = false;
                    
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                            mutation.addedNodes.forEach(node => {
                                if (node.nodeType === 1) { // Element node
                                    if (node.tagName === 'BUTTON' || node.querySelector('button')) {
                                        needsScan = true;
                                    }
                                }
                            });
                        }
                        if (mutation.type === 'attributes' && mutation.target.tagName === 'BUTTON') {
                            needsScan = true;
                        }
                    });
                    
                    if (needsScan) {
                        console.log('üîÑ [GHOST MONITOR] Nouveau bouton d√©tect√© - Scan automatique');
                        setTimeout(() => removeAllGhostButtonsDefinitively(), 100);
                    }
                });
                
                observer.observe(document.body, {
                    childList: true,
                    subtree: true,
                    attributes: true,
                    attributeFilter: ['style', 'class']
                });
                
                console.log('‚úÖ [GHOST MONITOR] Surveillance active');
            }
            
            // === EX√âCUTION IMM√âDIATE ET SURVEILLANCE ===
            removeAllGhostButtonsDefinitively();
            setTimeout(() => removeAllGhostButtonsDefinitively(), 500);
            setTimeout(() => removeAllGhostButtonsDefinitively(), 1000);
            setTimeout(() => removeAllGhostButtonsDefinitively(), 2000);
            setupGhostButtonMonitoring();
            
            // Configuration de la cr√©ation de devis
            setupQuoteCreation();
            
            function setupQuoteCreation() {
                console.log('üîÑ Configuration de la cr√©ation de devis...');
                
                // UNIQUEMENT LA VUE PLEIN √âCRAN - ANCIENNE MODAL SUPPRIM√âE
                const createQuoteBtn = document.getElementById('createQuoteBtn');
                const addServiceBtn = document.getElementById('addServiceBtn');
                
                console.log('üîç √âl√©ments trouv√©s:', {
                    createQuoteBtn: !!createQuoteBtn,
                    addServiceBtn: !!addServiceBtn,
                    quoteManager: !!window.quoteManager
                });
                
                // Ouvrir la vue cr√©ation de devis (pleine page)
                if (createQuoteBtn) {
                    console.log('‚úÖ Ajout du listener sur le bouton Nouveau Devis');
                    createQuoteBtn.addEventListener('click', () => {
                        console.log('üìù Ouverture de la vue cr√©ation de devis');
                        
                        // Afficher la vue cr√©ation de devis en plein √©cran
                        const newQuoteView = document.getElementById('newQuoteView');
                        if (newQuoteView) {
                            console.log('‚úÖ Vue newQuoteView trouv√©e, ouverture...');
                            newQuoteView.classList.remove('hidden');
                            
                            // FORCER LES STYLES POUR PRENDRE TOUT L'√âCRAN
                            newQuoteView.style.position = 'fixed';
                            newQuoteView.style.top = '0';
                            newQuoteView.style.left = '0';
                            newQuoteView.style.right = '0';
                            newQuoteView.style.bottom = '0';
                            newQuoteView.style.width = '100vw';
                            newQuoteView.style.height = '100vh';
                            newQuoteView.style.zIndex = '9999';
                            newQuoteView.style.backgroundColor = '#f3f4f6';
                            newQuoteView.style.overflowY = 'auto';
                            newQuoteView.style.margin = '0';
                            newQuoteView.style.padding = '0';
                            
                            console.log('üéØ Vue forc√©e en plein √©cran avec styles JavaScript');
                            
                            // SUPPRESSION IMM√âDIATE DES BOUTONS FANT√îMES √Ä L'OUVERTURE
                            console.log('üóëÔ∏è [OPEN VIEW] Nettoyage des boutons fant√¥mes √† l\'ouverture');
                            setTimeout(() => removeAllGhostButtonsDefinitively(), 50);
                            setTimeout(() => removeAllGhostButtonsDefinitively(), 200);
                            setTimeout(() => removeAllGhostButtonsDefinitively(), 500);
                            
                            // R√©initialiser le formulaire
                            const newQuoteForm = document.getElementById('newQuoteForm');
                            if (newQuoteForm) newQuoteForm.reset();
                            
                            // D√©finir la date du jour
                            const dateInput = document.getElementById('quoteDate');
                            if (dateInput) {
                                const today = new Date().toISOString().split('T')[0];
                                dateInput.value = today;
                            }
                        }
                    });
                } else {
                    console.error('‚ùå Bouton createQuoteBtn non trouv√© !');
                }
                
                // BOUTON RETOUR - VERSION ULTRA-SIMPLE
                const backToQuotesBtn = document.getElementById('backToQuotesBtn');
                if (backToQuotesBtn) {
                    console.log('üîß Configuration du bouton retour ultra-simple');
                    
                    // Supprimer tous les anciens event listeners
                    const newBtn = backToQuotesBtn.cloneNode(true);
                    backToQuotesBtn.parentNode.replaceChild(newBtn, backToQuotesBtn);
                    
                    // Fonction de fermeture simple
                    function retourUltraSimple(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üîô RETOUR ULTRA-SIMPLE - Fermeture vue devis');
                        closeNewQuoteViewCompletely();
                        return false;
                    }
                    
                    // UN SEUL event listener
                    newBtn.addEventListener('click', retourUltraSimple);
                    
                    // Forcer les styles de cliquabilit√© (au cas o√π)
                    newBtn.style.pointerEvents = 'auto';
                    
                    console.log('‚úÖ Bouton retour ultra-simple configur√©');
                }
                
                // Supprimer l'ancien event listener global redondant
                
                // AJOUT: Event listener pour la touche ESC pour fermer la vue
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const newQuoteView = document.getElementById('newQuoteView');
                        if (newQuoteView && !newQuoteView.classList.contains('hidden')) {
                            e.preventDefault();
                            console.log('‚å®Ô∏è TOUCHE ESC - Fermeture vue Nouveau Devis');
                            closeNewQuoteViewCompletely();
                        }
                    }
                });
                
                // Bouton "Ajouter une prestation" - VERSION SANS colonne Total
                const addServiceBtnFullPage = document.getElementById('addServiceBtn');
                if (addServiceBtnFullPage) {
                    console.log('‚úÖ Bouton Ajouter une prestation trouv√© et configur√©');
                    addServiceBtnFullPage.addEventListener('click', () => {
                        console.log('üîÑ Ajout d\\\'une nouvelle prestation...');
                        const container = document.getElementById('servicesContainerFullPage');
                        if (container) {
                            const newService = document.createElement('div');
                            newService.className = 'flex items-center gap-3 p-3 bg-white rounded-lg border shadow-sm';
                            newService.innerHTML = `
                                <div class="flex-1">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Description de la prestation</label>
                                    <input type="text" name="service_description[]" placeholder="D√©crivez votre prestation..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" required>
                                </div>
                                <div class="w-16">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Quantit√©</label>
                                    <input type="number" name="service_quantity[]" min="1" value="1" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm text-center" required>
                                </div>
                                <div class="w-28">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Prix HT</label>
                                    <input type="number" name="service_price[]" step="0.01" min="0" placeholder="0.00 ‚Ç¨" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm text-right" required>
                                </div>
                                <div class="flex items-end">
                                    <button type="button" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors" onclick="this.closest('.flex.items-center').remove(); updateTotal();" title="Supprimer cette prestation">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            `;
                            container.appendChild(newService);
                            
                            // Ajouter les event listeners pour le calcul automatique
                            newService.querySelectorAll('input[name="service_quantity[]"], input[name="service_price[]"]').forEach(input => {
                                input.addEventListener('input', updateTotal);
                            });
                            
                            updateTotal();
                        }
                    });
                }
                
                // Nouveau bouton "Ajouter une prestation" dans la section Notes
                const addServiceBtnBottom = document.getElementById('addServiceBtnBottom');
                if (addServiceBtnBottom) {
                    addServiceBtnBottom.addEventListener('click', () => {
                        const container = document.getElementById('servicesContainerFullPage');
                        if (container) {
                            const newService = document.createElement('div');
                            newService.className = 'flex items-center gap-3 p-3 bg-white rounded-lg border shadow-sm';
                            newService.innerHTML = `
                                <div class="flex-1">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Description de la prestation</label>
                                    <input type="text" name="service_description[]" placeholder="D√©crivez votre prestation..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" required>
                                </div>
                                <div class="w-16">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Quantit√©</label>
                                    <input type="number" name="service_quantity[]" min="1" value="1" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm text-center" required>
                                </div>
                                <div class="w-28">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Prix HT</label>
                                    <input type="number" name="service_price[]" step="0.01" min="0" placeholder="0.00 ‚Ç¨" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm text-right" required>
                                </div>
                                <div class="flex items-end">
                                    <button type="button" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors" onclick="this.closest('.flex.items-center').remove(); updateTotal();" title="Supprimer cette prestation">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                                </div>
                            `;
                            container.appendChild(newService);
                            
                            // Ajouter les event listeners pour le calcul automatique
                            newService.querySelectorAll('input[name="service_quantity[]"], input[name="service_price[]"]').forEach(input => {
                                input.addEventListener('input', updateTotal);
                            });
                            
                            updateTotal();
                        }
                    });
                }
                
                // Nouveau bouton "Ajouter une prestation" dans la section Notes
                const addServiceBtnNotes = document.getElementById('addServiceBtnNotes');
                if (addServiceBtnNotes) {
                    console.log('‚úÖ Bouton Ajouter prestation (Notes) trouv√© et configur√©');
                    addServiceBtnNotes.addEventListener('click', () => {
                        console.log('üîÑ Ajout d\\\'une nouvelle prestation depuis Notes...');
                        const container = document.getElementById('servicesContainerFullPage');
                        if (container) {
                            const newService = document.createElement('div');
                            newService.className = 'flex items-center gap-3 p-3 bg-white rounded-lg border shadow-sm';
                            newService.innerHTML = `
                                <div class="flex-1">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Description de la prestation</label>
                                    <input type="text" name="service_description[]" placeholder="D√©crivez votre prestation..." class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm" required>
                                </div>
                                <div class="w-16">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Quantit√©</label>
                                    <input type="number" name="service_quantity[]" min="1" value="1" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm text-center" required>
                                </div>
                                <div class="w-28">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Prix HT</label>
                                    <input type="number" name="service_price[]" step="0.01" min="0" placeholder="0.00 ‚Ç¨" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm text-right" required>
                                </div>
                                <div class="flex items-end">
                                    <button type="button" class="text-red-500 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-colors" onclick="this.closest('.flex.items-center').remove(); updateTotal();" title="Supprimer cette prestation">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            `;
                            container.appendChild(newService);
                            
                            // Ajouter les event listeners pour le calcul automatique
                            newService.querySelectorAll('input[name="service_quantity[]"], input[name="service_price[]"]').forEach(input => {
                                input.addEventListener('input', updateTotal);
                            });
                            
                            updateTotal();
                        }
                    });
                }
                
                // Bouton "Enregistrer le Devis" dans la vue pleine page
                const saveQuoteBtnFullPage = document.getElementById('saveQuoteBtn');
                const saveQuoteBtnMain = document.getElementById('saveQuoteBtnMain');
                console.log('üîç Boutons Enregistrer trouv√©s:', {saveQuoteBtnFullPage, saveQuoteBtnMain});
                
                // Fonction utilitaire pour attendre que jsPDF soit charg√© (version simplifi√©e)
                function waitForJsPDF(maxRetries = 5, delay = 200) {
                    return new Promise((resolve, reject) => {
                        let retries = 0;
                        
                        function checkJsPDF() {
                            console.log(`üîç V√©rification jsPDF tentative ${retries + 1}/${maxRetries}...`);
                            
                            // Essayer d'instancier jsPDF directement
                            try {
                                // M√©thode 1: window.jspdf.jsPDF (version moderne)
                                if (window.jspdf && typeof window.jspdf.jsPDF === 'function') {
                                    const testDoc = new window.jspdf.jsPDF();
                                    if (testDoc) {
                                        console.log('‚úÖ jsPDF fonctionne via window.jspdf.jsPDF');
                                        resolve(window.jspdf.jsPDF);
                                        return;
                                    }
                                }
                                
                                // M√©thode 2: window.jsPDF directement
                                if (window.jsPDF && typeof window.jsPDF === 'function') {
                                    const testDoc = new window.jsPDF();
                                    if (testDoc) {
                                        console.log('‚úÖ jsPDF fonctionne via window.jsPDF');
                                        resolve(window.jsPDF);
                                        return;
                                    }
                                }
                                
                                // M√©thode 3: window.jsPDF.jsPDF
                                if (window.jsPDF && window.jsPDF.jsPDF && typeof window.jsPDF.jsPDF === 'function') {
                                    const testDoc = new window.jsPDF.jsPDF();
                                    if (testDoc) {
                                        console.log('‚úÖ jsPDF fonctionne via window.jsPDF.jsPDF');
                                        resolve(window.jsPDF.jsPDF);
                                        return;
                                    }
                                }
                                
                            } catch (testError) {
                                console.warn('‚ö†Ô∏è Erreur lors du test jsPDF:', testError);
                            }
                            
                            retries++;
                            if (retries >= maxRetries) {
                                console.error('‚ùå jsPDF non disponible apr√®s', maxRetries, 'tentatives');
                                reject(new Error('jsPDF n\\\'a pas pu √™tre charg√©. V√©rifiez votre connexion internet ou rechargez la page.'));
                                return;
                            }
                            
                            console.log('‚è≥ Nouvelle tentative dans', delay + 'ms...');
                            setTimeout(checkJsPDF, delay);
                        }
                        
                        checkJsPDF();
                    });
                }
                
                // Fonction de sauvegarde commune
                window.handleSaveQuote = async (buttonElement) => {
                    console.log('üíæ Clic sur le bouton Enregistrer d√©tect√© !');
                    
                    const form = document.getElementById('newQuoteForm');
                    console.log('üìã Formulaire trouv√©:', form);
                    
                    if (!form) {
                        console.error('‚ùå Formulaire non trouv√© !');
                        alert('‚ùå Erreur - Formulaire non trouv√©');
                        return;
                    }
                    
                    console.log('üîç V√©rification validit√© du formulaire...');
                    const isValid = form.checkValidity();
                    console.log('üìã Formulaire valide:', isValid);
                    
                    if (!isValid) {
                        console.warn('‚ö†Ô∏è Formulaire invalide, affichage des erreurs...');
                        form.reportValidity();
                        alert('Veuillez remplir tous les champs obligatoires');
                        return;
                    }
                    
                    console.log('‚úÖ Formulaire valide, d√©but de la sauvegarde...');
                    
                    // D√©sactiver le bouton pendant le traitement (avec v√©rification)
                    let originalText = '';
                    if (buttonElement && buttonElement.textContent) {
                        originalText = buttonElement.textContent;
                        buttonElement.disabled = true;
                        buttonElement.textContent = 'Cr√©ation en cours...';
                    }
                    
                    try {
                        const formData = new FormData(form);
                        const quoteData = {
                            clientName: formData.get('clientName') || 'Client non sp√©cifi√©',
                            clientEmail: formData.get('clientEmail') || '',
                            clientPhone: formData.get('clientPhone') || '',
                            clientAddress: formData.get('clientAddress') || '',
                            quoteDate: formData.get('quoteDate') || new Date().toISOString().split('T')[0],
                            notes: formData.get('quoteNotes') || '',
                            services: [],
                            createdAt: new Date().toISOString()
                        };
                        
                        console.log('üìä Collecte des services...');
                        const serviceInputs = document.querySelectorAll('#servicesContainerFullPage > div');
                        console.log('üìä Nombre de lignes de services trouv√©es:', serviceInputs.length);
                        console.log('üìä Container selector:', '#servicesContainerFullPage > div');
                        console.log('üìä Container existant:', !!document.querySelector('#servicesContainerFullPage'));
                        
                        if (serviceInputs.length === 0) {
                            console.warn('‚ö†Ô∏è AUCUNE ligne de service trouv√©e - v√©rification alternative...');
                            // V√©rifier avec d'autres s√©lecteurs possibles
                            const altServices1 = document.querySelectorAll('.service-row');
                            const altServices2 = document.querySelectorAll('[id*="service"]');
                            const allInputs = document.querySelectorAll('input[name*="service"], textarea[name*="service"], select[name*="service"]');
                            console.log('üìä Alternative 1 (.service-row):', altServices1.length);
                            console.log('üìä Alternative 2 ([id*="service"]):', altServices2.length);
                            console.log('üìä All service inputs:', allInputs.length);
                        }
                        
                        serviceInputs.forEach((serviceRow, index) => {
                            console.log(`üìä Analyse ligne ${index + 1}:`, serviceRow);
                            const description = serviceRow.querySelector('textarea[name="service_description[]"]')?.value || serviceRow.querySelector('input[name="service_description[]"]')?.value;
                            const quantity = parseFloat(serviceRow.querySelector('input[name="service_quantity[]"]')?.value) || 0;
                            const unit = serviceRow.querySelector('select[name="service_unit[]"]')?.value || '';
                            const price = parseFloat(serviceRow.querySelector('input[name="service_price[]"]')?.value) || 0;
                            
                            console.log(`üìä Service ${index + 1}:`, {
                                description: description?.substring(0, 50) + '...',
                                quantity,
                                unit,
                                price,
                                validDescription: !!(description && description.trim()),
                                validQuantity: quantity > 0,
                                validPrice: price > 0
                            });
                            
                            if (description && description.trim() && quantity > 0 && price > 0) {
                                quoteData.services.push({
                                    description: description.trim(),
                                    quantity: quantity,
                                    unit: unit,
                                    price: price
                                });
                                console.log('‚úÖ Service ajout√© √† la liste');
                            } else {
                                console.warn('‚ö†Ô∏è Service ignor√© - donn√©es manquantes ou invalides');
                            }
                        });
                        
                        console.log('üìä Nombre total de services valides:', quoteData.services.length);
                        
                        if (quoteData.services.length === 0) {
                            throw new Error('Veuillez ajouter au moins une prestation valide');
                        }
                        
                        // Calculer les totaux
                        let totalHT = 0;
                        quoteData.services.forEach(service => {
                            totalHT += service.quantity * service.price;
                        });
                        
                        const totalTVA = totalHT * 0.20; // TVA 20%
                        const totalTTC = totalHT + totalTVA;
                        
                        quoteData.totalHT = totalHT;
                        quoteData.totalTVA = totalTVA;
                        quoteData.totalTTC = totalTTC;
                        
                        console.log('üìÑ Donn√©es du devis:', quoteData);
                        
                        // Sauvegarder en base de donn√©es OBLIGATOIREMENT
                        if (buttonElement && buttonElement.textContent) {
                            buttonElement.textContent = 'Sauvegarde en cours...';
                        }
                        console.log('üíæ Sauvegarde en base de donn√©es...');
                        
                        // DEBUG: V√©rifier l'√©tat des services
                        console.log('üîç DEBUG - √âtat des services:', {
                            'window.dbService existe': !!window.dbService,
                            'window.dbService type': typeof window.dbService,
                            'dbService.createQuote existe': window.dbService && typeof window.dbService.createQuote,
                            'window.authService existe': !!window.authService,
                            'window.authService type': typeof window.authService
                        });
                        
                        // V√©rifier si l'utilisateur est authentifi√©
                        if (window.authService) {
                            console.log('üîç V√©rification utilisateur authentifi√©...');
                            
                            // V√©rification double : √©tat d'authentification ET utilisateur actuel
                            const isAuthenticated = window.authService.isUserAuthenticated();
                            const currentUser = await window.authService.getCurrentUser();
                            
                            console.log('üë§ √âtat d\\\'authentification:', isAuthenticated);
                            console.log('üë§ Utilisateur actuel:', currentUser ? { id: currentUser.id, email: currentUser.email } : 'Aucun');
                            
                            if (!isAuthenticated || !currentUser) {
                                console.error('‚ùå Utilisateur non authentifi√© dans AuthService');
                                
                                // Essayer de r√©initialiser l'AuthService pour r√©cup√©rer la session
                                console.log('üîÑ Tentative de r√©cup√©ration de session...');
                                try {
                                    const initialized = await window.authService.initialize();
                                    if (initialized) {
                                        const recoveredUser = window.authService.getCurrentUser();
                                        console.log('üîÑ Session r√©cup√©r√©e:', recoveredUser ? recoveredUser.email : 'Aucune');
                                        
                                        if (recoveredUser) {
                                            // Transmettre l'utilisateur au service de base de donn√©es
                                            if (window.dbService && typeof window.dbService.setCurrentUser === 'function') {
                                                window.dbService.setCurrentUser(recoveredUser);
                                                console.log('üë§ Utilisateur retransmis au service de base de donn√©es');
                                            }
                                        } else {
                                            throw new Error('Impossible de r√©cup√©rer la session utilisateur.');
                                        }
                                    } else {
                                        throw new Error('√âchec de r√©initialisation de l\'authentification.');
                                    }
                                } catch (recoveryError) {
                                    console.error('‚ùå √âchec de r√©cup√©ration de session:', recoveryError);
                                    throw new Error('Utilisateur non authentifi√©. Veuillez vous reconnecter.');
                                }
                            } else {
                                // Utilisateur authentifi√©, s'assurer qu'il est bien transmis au service de base de donn√©es
                                if (window.dbService && typeof window.dbService.setCurrentUser === 'function') {
                                    window.dbService.setCurrentUser(currentUser);
                                    console.log('üë§ Utilisateur confirm√© dans le service de base de donn√©es');
                                }
                            }
                        } else {
                            console.error('‚ùå AuthService non disponible');
                            throw new Error('Service d\'authentification non disponible.');
                        }
                        
                        if (window.dbService && typeof window.dbService.createQuote === 'function') {
                            try {
                                console.log('üíæ Appel createQuote avec les donn√©es:', {
                                    clientName: quoteData.clientName,
                                    servicesCount: quoteData.services.length,
                                    totalTTC: quoteData.totalTTC
                                });
                                
                                const dbResult = await window.dbService.createQuote(quoteData);
                                console.log('‚úÖ Devis sauvegard√© en base de donn√©es:', dbResult);
                                
                                if (dbResult && dbResult.id) {
                                    quoteData.id = dbResult.id; // Garder l'ID pour r√©f√©rence
                                    console.log('‚úÖ ID du devis cr√©√©:', dbResult.id);
                                } else {
                                    console.warn('‚ö†Ô∏è Aucun ID retourn√© par createQuote:', dbResult);
                                }
                                
                            } catch (dbError) {
                                console.error('‚ùå Erreur critique base de donn√©es:', dbError);
                                console.error('‚ùå Stack trace:', dbError.stack);
                                throw new Error('Impossible de sauvegarder en base de donn√©es: ' + dbError.message);
                            }
                        } else {
                            console.error('‚ùå Service de base de donn√©es non disponible');
                            console.error('‚ùå window.dbService:', window.dbService);
                            console.error('‚ùå createQuote type:', window.dbService ? typeof window.dbService.createQuote : 'N/A');
                            throw new Error('Service de base de donn√©es non disponible');
                        }
                        
                        // Essayer de g√©n√©rer le PDF (optionnel, ne bloque pas si √ßa √©choue)
                        if (buttonElement && buttonElement.textContent) {
                            buttonElement.textContent = 'G√©n√©ration PDF...';
                        }
                        let pdfGenerated = false;
                        
                        try {
                            console.log('üîÑ Tentative de g√©n√©ration PDF...');
                            await generateAndDownloadPDF(quoteData);
                            pdfGenerated = true;
                            console.log('‚úÖ PDF g√©n√©r√© avec succ√®s');
                        } catch (pdfError) {
                            console.warn('‚ö†Ô∏è Erreur PDF (devis sauvegard√© quand m√™me):', pdfError);
                            // Le PDF a √©chou√©, mais on continue car le devis est sauvegard√©
                        }
                        
                        // Message de succ√®s adapt√©
                        if (pdfGenerated) {
                            alert('‚úÖ Devis cr√©√© et sauvegard√© avec succ√®s ! Le PDF a √©t√© t√©l√©charg√©.');
                        } else {
                            alert('‚úÖ Devis sauvegard√© avec succ√®s !\\n‚ö†Ô∏è Le PDF n\\\'a pas pu √™tre g√©n√©r√©, mais vous pouvez le reg√©n√©rer depuis la liste des devis.');
                        }
                        
                        // Fermer la vue apr√®s succ√®s
                        closeNewQuoteViewCompletely();
                        
                    } catch (error) {
                        console.error('‚ùå Erreur lors de la cr√©ation du devis:', error);
                        alert('‚ùå Erreur - ' + error.message);
                    } finally {
                        // R√©activer le bouton
                        if (buttonElement) {
                            buttonElement.disabled = false;
                            if (originalText) {
                                buttonElement.textContent = originalText;
                            }
                        }
                    }
                };

                // Configuration des √©v√©nements pour les deux boutons
                if (saveQuoteBtnFullPage) {
                    console.log('‚úÖ Configuration du bouton Enregistrer (header)...');
                    saveQuoteBtnFullPage.addEventListener('click', () => window.handleSaveQuote(saveQuoteBtnFullPage));
                }

                if (saveQuoteBtnMain) {
                    console.log('‚úÖ Configuration du bouton Enregistrer principal (bas de page)...');
                    saveQuoteBtnMain.addEventListener('click', () => window.handleSaveQuote(saveQuoteBtnMain));
                } else {
                    console.error('‚ùå Bouton principal d\\\'enregistrement non trouv√© !');
                }
                
                // Fonction pour g√©n√©rer et t√©l√©charger le PDF (version simplifi√©e et robuste)
                async function generateAndDownloadPDF(quoteData) {
                    try {
                        console.log('üîÑ D√©but g√©n√©ration PDF...');
                        
                        // Attendre que jsPDF soit charg√© avec d√©lai r√©duit
                        const jsPDFClass = await waitForJsPDF();
                        console.log('‚úÖ jsPDF disponible, cr√©ation du document...');
                        
                        const doc = new jsPDFClass();
                        
                        // Configuration de base
                        const margin = 20;
                        const pageWidth = doc.internal.pageSize.getWidth();
                        let y = margin;
                        
                        // En-t√™te simple
                        doc.setFontSize(18);
                        doc.text('DEVIS', pageWidth / 2, y, { align: 'center' });
                        y += 15;
                        
                        // Num√©ro et date
                        doc.setFontSize(10);
                        const quoteNumber = 'DEV-' + Date.now().toString().slice(-6);
                        doc.text(`N¬∞ ${quoteNumber}`, margin, y);
                        doc.text(`Date: ${new Date().toLocaleDateString('fr-FR')}`, pageWidth - margin, y, { align: 'right' });
                        y += 15;
                        
                        // Client
                        doc.text('CLIENT:', margin, y);
                        y += 8;
                        doc.text(quoteData.clientName || 'Client non sp√©cifi√©', margin, y);
                        if (quoteData.clientEmail) {
                            y += 6;
                            doc.text(quoteData.clientEmail, margin, y);
                        }
                        y += 15;
                        
                        // Services
                        doc.text('PRESTATIONS:', margin, y);
                        y += 10;
                        
                        quoteData.services.forEach((service, index) => {
                            const total = service.quantity * service.price;
                            doc.text(`${index + 1}. ${service.description}`, margin, y);
                            y += 6;
                            doc.text(`   Qt√©: ${service.quantity} | Prix: ${service.price.toFixed(2)}‚Ç¨ | Total: ${total.toFixed(2)}‚Ç¨`, margin, y);
                            y += 8;
                        });
                        
                        // Totaux
                        y += 10;
                        doc.text(`Total HT: ${quoteData.totalHT.toFixed(2)} ‚Ç¨`, margin, y);
                        y += 6;
                        doc.text(`TVA 20%: ${quoteData.totalTVA.toFixed(2)} ‚Ç¨`, margin, y);
                        y += 6;
                        doc.setFontSize(12);
                        doc.text(`TOTAL TTC: ${quoteData.totalTTC.toFixed(2)} ‚Ç¨`, margin, y);
                        
                        // Notes si pr√©sentes
                        if (quoteData.notes && quoteData.notes.trim()) {
                            y += 15;
                            doc.setFontSize(10);
                            doc.text('Notes:', margin, y);
                            y += 6;
                            const lines = doc.splitTextToSize(quoteData.notes, pageWidth - 2 * margin);
                            doc.text(lines, margin, y);
                        }
                        
                        // T√©l√©charger
                        const filename = `devis-${quoteNumber}-${new Date().toISOString().split('T')[0]}.pdf`;
                        console.log('üíæ T√©l√©chargement du PDF:', filename);
                        doc.save(filename);
                        
                        console.log('‚úÖ PDF g√©n√©r√© et t√©l√©charg√© avec succ√®s');
                        
                    } catch (error) {
                        console.error('‚ùå Erreur lors de la g√©n√©ration du PDF:', error);
                        throw new Error(`Erreur lors de la g√©n√©ration du PDF: ${error.message}`);
                    }
                }
                
                // Fonction pour mettre √† jour le total
                window.updateTotal = function() {
                    let totalHT = 0;
                    
                    document.querySelectorAll('#servicesContainerFullPage > div').forEach(serviceRow => {
                        const quantity = parseFloat(serviceRow.querySelector('input[name="service_quantity[]"]')?.value) || 0;
                        const price = parseFloat(serviceRow.querySelector('input[name="service_price[]"]')?.value) || 0;
                        totalHT += quantity * price;
                    });
                    
                    const tva = totalHT * 0.20;
                    const totalTTC = totalHT + tva;
                    
                // Mettre √† jour l'affichage des totaux avec v√©rification null
                function updateTotalsDisplay() {
                    const totalAmount = document.getElementById('totalAmount');
                    const taxAmount = document.getElementById('taxAmount');
                    const totalAmountTTC = document.getElementById('totalAmountTTC');
                    const totalHT = document.getElementById('totalHT');
                    const totalTVA = document.getElementById('totalTVA');
                    const totalTTC = document.getElementById('totalTTC');
                    
                    if (totalAmount) totalAmount.textContent = totalHT.toFixed(2) + ' ‚Ç¨';
                    if (taxAmount) taxAmount.textContent = tva.toFixed(2) + ' ‚Ç¨';
                    if (totalAmountTTC) totalAmountTTC.textContent = totalTTC.toFixed(2) + ' ‚Ç¨';
                }
                };
                
                // Ajouter les event listeners pour le calcul automatique sur les champs existants
                document.querySelectorAll('#servicesContainerFullPage input[name="service_quantity[]"], #servicesContainerFullPage input[name="service_price[]"]').forEach(input => {
                    input.addEventListener('input', updateTotal);
                });
            }
        });
        
        // FONCTION setupQuoteCreation DUPLIQU√âE SUPPRIM√âE
        // Une seule version existe maintenant pour √©viter les conflits
        
        // Classe QuoteManager pour g√©rer les devis
        class QuoteManager {
            constructor() {
                this.services = [];
                this.currentQuote = null;
            }
            
            // Calculer les totaux
            calculateTotals() {
                let totalHT = 0;
                
                document.querySelectorAll('.service-item').forEach(item => {
                    const quantity = parseFloat(item.querySelector('.service-quantity').value) || 0;
                    const price = parseFloat(item.querySelector('.service-price').value) || 0;
                    totalHT += quantity * price;
                });
                
                const totalTVA = totalHT * 0.20; // TVA 20%
                const totalTTC = totalHT + totalTVA;
                
                // Mise √† jour des totaux avec v√©rification null
                const totalHTElement = document.getElementById('totalHT');
                const totalTVAElement = document.getElementById('totalTVA');
                const totalTTCElement = document.getElementById('totalTTC');
                
                if (totalHTElement) {
                    totalHTElement.textContent = totalHT.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
                }
                if (totalTVAElement) {
                    totalTVAElement.textContent = totalTVA.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
                }
                if (totalTTCElement) {
                    totalTTCElement.textContent = totalTTC.toLocaleString('fr-FR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' ‚Ç¨';
                }
                
                return { totalHT, totalTVA, totalTTC };
            }
            
            // Ajouter une prestation
            addService() {
                const container = document.getElementById('servicesContainer');
                
                const serviceHTML = `
                    <div class="service-item bg-gray-50 p-4 rounded-lg mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Description *</label>
                                <input type="text" class="service-description w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Description de la prestation" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Quantit√© *</label>
                                <input type="number" class="service-quantity w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="1" min="1" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Prix unitaire HT *</label>
                                <input type="number" class="service-price w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" step="0.01" min="0" placeholder="0.00" required>
                            </div>
                            <div class="flex items-end">
                                <button type="button" class="remove-service-btn w-full bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg font-medium transition-colors">
                                    Supprimer
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.insertAdjacentHTML('beforeend', serviceHTML);
                this.setupServiceEventListeners();
                this.calculateTotals();
            }
            
            // Supprimer une prestation
            removeService(serviceElement) {
                const container = document.getElementById('servicesContainer');
                if (container.children.length > 1) {
                    serviceElement.remove();
                    this.calculateTotals();
                }
            }
            
            // Configurer les event listeners pour les prestations
            setupServiceEventListeners() {
                // Calculer les totaux quand les valeurs changent
                document.querySelectorAll('.service-quantity, .service-price').forEach(input => {
                    input.removeEventListener('input', this.calculateTotals.bind(this));
                    input.addEventListener('input', this.calculateTotals.bind(this));
                });
                
                // Supprimer une prestation
                document.querySelectorAll('.remove-service-btn').forEach(btn => {
                    btn.removeEventListener('click', this.handleRemoveService.bind(this));
                    btn.addEventListener('click', this.handleRemoveService.bind(this));
                });
            }
            
            handleRemoveService(e) {
                const serviceItem = e.target.closest('.service-item');
                this.removeService(serviceItem);
            }
            
            // G√©n√©rer le PDF du devis
            async generatePDF(quoteData) {
                console.log('üîÑ G√©n√©ration du PDF...', quoteData);
                
                // V√©rifier que jsPDF est disponible
                if (typeof window.jsPDF === 'undefined') {
                    console.error('‚ùå jsPDF non disponible');
                    alert('Erreur - La biblioth√®que de g√©n√©ration PDF n\\\'est pas disponible.');
                    return;
                }
                
                try {
                    const { jsPDF } = window.jsPDF;
                    const doc = new jsPDF();
                    
                    // Configuration
                    const pageWidth = doc.internal.pageSize.width;
                    const pageHeight = doc.internal.pageSize.height;
                    const margin = 20;
                    let currentY = margin;
                    
                    // Couleurs
                    const primaryColor = [37, 99, 235]; // Blue-600
                    const textColor = [55, 65, 81]; // Gray-700
                    const lightGray = [243, 244, 246]; // Gray-100
                    
                    // En-t√™te
                    doc.setFontSize(24);
                    doc.setTextColor(...primaryColor);
                    doc.text('DEVIS', pageWidth / 2, currentY, { align: 'center' });
                    currentY += 15;
                    
                    // Num√©ro de devis et date
                    doc.setFontSize(12);
                    doc.setTextColor(...textColor);
                    const quoteNumber = 'DEVIS-' + Date.now().toString().slice(-6);
                    const quoteDate = new Date().toLocaleDateString('fr-FR');
                    
                    doc.text(`Num√©ro: ${quoteNumber}`, margin, currentY);
                    doc.text(`Date: ${quoteDate}`, pageWidth - margin, currentY, { align: 'right' });
                    currentY += 20;
                    
                    // Informations entreprise (√† gauche)
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('DE :', margin, currentY);
                    doc.setFont(undefined, 'normal');
                    currentY += 6;
                    
                    const companyInfo = [
                        'Mon Entreprise',
                        '123 Rue Example',
                        '75000 Paris',
                        'Tel: 01 23 45 67 89',
                        'Email: contact@monentreprise.fr'
                    ];
                    
                    companyInfo.forEach(line => {
                        doc.text(line, margin, currentY);
                        currentY += 5;
                    });
                    
                    // Informations client (√† droite)
                    currentY = margin + 35; // R√©initialiser Y pour aligner avec l'entreprise
                    doc.setFont(undefined, 'bold');
                    doc.text('POUR :', pageWidth / 2 + 10, currentY);
                    doc.setFont(undefined, 'normal');
                    currentY += 6;
                    
                    const clientInfo = [
                        quoteData.clientName || 'Client non sp√©cifi√©',
                        quoteData.clientAddress || '',
                        quoteData.clientPhone || '',
                        quoteData.clientEmail || ''
                    ].filter(line => line); // Supprimer les lignes vides
                    
                    clientInfo.forEach(line => {
                        doc.text(line, pageWidth / 2 + 10, currentY);
                        currentY += 5;
                    });
                    
                    currentY = Math.max(currentY, margin + 70); // S'assurer qu'on a assez d'espace
                    
                    // Tableau des prestations
                    currentY += 10;
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('PRESTATIONS', margin, currentY);
                    currentY += 10;
                    
                    // En-t√™tes du tableau
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    const headers = ['Description', 'Qt√©', 'Prix unit. HT', 'Total HT'];
                    const colWidths = [100, 20, 30, 30];
                    let currentX = margin;
                    
                    // Dessiner les en-t√™tes
                    doc.setFillColor(...lightGray);
                    doc.rect(margin, currentY - 5, pageWidth - 2 * margin, 10, 'F');
                    
                    headers.forEach((header, index) => {
                        doc.text(header, currentX + 2, currentY);
                        currentX += colWidths[index];
                    });
                    currentY += 10;
                    
                    // Lignes du tableau
                    doc.setFont(undefined, 'normal');
                    let totalHT = 0;
                    
                    quoteData.services.forEach((service, index) => {
                        const lineTotal = service.quantity * service.price;
                        totalHT += lineTotal;
                        
                        currentX = margin;
                        const values = [
                            service.description,
                            service.quantity.toString(),
                            service.price.toFixed(2) + ' ‚Ç¨',
                            lineTotal.toFixed(2) + ' ‚Ç¨'
                        ];
                        
                        // Dessiner ligne altern√©e
                        if (index % 2 === 1) {
                            doc.setFillColor(248, 250, 252); // Gray-50
                            doc.rect(margin, currentY - 5, pageWidth - 2 * margin, 8, 'F');
                        }
                        
                        values.forEach((value, colIndex) => {
                            if (colIndex === 0) {
                                // Description - peut √™tre longue
                                const lines = doc.splitTextToSize(value, colWidths[colIndex] - 4);
                                doc.text(lines, currentX + 2, currentY);
                            } else {
                                // Autres colonnes - alignement √† droite
                                doc.text(value, currentX + colWidths[colIndex] - 2, currentY, { align: 'right' });
                            }
                            currentX += colWidths[colIndex];
                        });
                        
                        currentY += 8;
                    });
                    
                    // Totaux
                    currentY += 10;
                    const totalTVA = totalHT * 0.20;
                    const totalTTC = totalHT + totalTVA;
                    
                    doc.setFont(undefined, 'bold');
                    const totalsX = pageWidth - margin - 60;
                    
                    doc.text('Total HT :', totalsX - 30, currentY);
                    doc.text(totalHT.toFixed(2) + ' ‚Ç¨', totalsX, currentY, { align: 'right' });
                    currentY += 7;
                    
                    doc.text('TVA (20%) :', totalsX - 30, currentY);
                    doc.text(totalTVA.toFixed(2) + ' ‚Ç¨', totalsX, currentY, { align: 'right' });
                    currentY += 7;
                    
                    doc.setFontSize(12);
                    doc.text('Total TTC :', totalsX - 30, currentY);
                    doc.text(totalTTC.toFixed(2) + ' ‚Ç¨', totalsX, currentY, { align: 'right' });
                    
                    // Notes
                    if (quoteData.notes && quoteData.notes.trim()) {
                        currentY += 20;
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                        doc.text('Notes :', margin, currentY);
                        currentY += 6;
                        
                        doc.setFont(undefined, 'normal');
                        const noteLines = doc.splitTextToSize(quoteData.notes, pageWidth - 2 * margin);
                        doc.text(noteLines, margin, currentY);
                    }
                    
                    // Pied de page
                    currentY = pageHeight - 40;
                    doc.setFontSize(8);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Devis valable 30 jours √† compter de la date d\'√©mission', pageWidth / 2, currentY, { align: 'center' });
                    currentY += 5;
                    doc.text('Conditions de paiement : 30 jours net', pageWidth / 2, currentY, { align: 'center' });
                    
                    // Sauvegarder le PDF
                    const filename = `Devis_${quoteNumber}_${quoteData.clientName.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
                    doc.save(filename);
                    
                    console.log('‚úÖ PDF g√©n√©r√© et t√©l√©charg√©:', filename);
                    return { filename, quoteNumber, totalTTC };
                    
                } catch (error) {
                    console.error('‚ùå Erreur lors de la g√©n√©ration du PDF:', error);
                    throw error;
                }
            }
            
            // Cr√©er un devis
            async createQuote(formData) {
                try {
                    console.log('üîÑ Cr√©ation du devis...', formData);
                    
                    // Pr√©parer les donn√©es du devis
                    const quoteData = {
                        clientName: formData.get('clientName'),
                        clientEmail: formData.get('clientEmail'),
                        clientPhone: formData.get('clientPhone'),
                        clientAddress: formData.get('clientAddress'),
                        notes: formData.get('notes'),
                        services: [],
                        createdAt: new Date().toISOString()
                    };
                    
                    // Collecter les prestations
                    document.querySelectorAll('.service-item').forEach(item => {
                        const description = item.querySelector('.service-description').value;
                        const quantity = parseFloat(item.querySelector('.service-quantity').value) || 0;
                        const price = parseFloat(item.querySelector('.service-price').value) || 0;
                        
                        if (description && quantity > 0 && price > 0) {
                            quoteData.services.push({
                                description,
                                quantity,
                                price
                            });
                        }
                    });
                    
                    if (quoteData.services.length === 0) {
                        throw new Error('Veuillez ajouter au moins une prestation');
                    }
                    
                    // Calculer les totaux
                    const totals = this.calculateTotals();
                    quoteData.totalHT = totals.totalHT;
                    quoteData.totalTVA = totals.totalTVA;
                    quoteData.totalTTC = totals.totalTTC;
                    
                    // Sauvegarder en base de donn√©es (si connect√©)
                    if (window.dbService && typeof window.dbService.createQuote === 'function') {
                        try {
                            await window.dbService.createQuote(quoteData);
                            console.log('‚úÖ Devis sauvegard√© en base de donn√©es');
                        } catch (error) {
                            console.warn('‚ö†Ô∏è Erreur lors de la sauvegarde en base:', error);
                        }
                    }
                    
                    // G√©n√©rer et t√©l√©charger le PDF
                    const result = await this.generatePDF(quoteData);
                    
                    return {
                        success: true,
                        message: `Devis ${result.quoteNumber} cr√©√© et t√©l√©charg√© avec succ√®s !`,
                        data: quoteData,
                        filename: result.filename
                    };
                    
                } catch (error) {
                    console.error('‚ùå Erreur lors de la cr√©ation du devis:', error);
                    return {
                        success: false,
                        message: error.message || 'Erreur lors de la cr√©ation du devis'
                    };
                }
            }
        }
        
        // Instance globale du QuoteManager
        window.quoteManager = new QuoteManager();
        
        // SOLUTION D√âFINITIVE - SUPPRIMER LES BOUTONS INVISIBLES SP√âCIFIQUES
        function supprimerBoutonsInvisiblesDefinitif() {
            console.log('üî• === SUPPRESSION PHYSIQUE D√âFINITIVE DES BOUTONS BLANCS ===');
            
            function supprimerTousBoutonsBlancs() {
                console.log('ÔøΩÔ∏è Suppression physique de TOUS les boutons blancs...');
                
                // Chercher ABSOLUMENT TOUS les √©l√©ments interactifs
                const selecteurs = [
                    '#newQuoteView button',
                    '#newQuoteView [onclick]',
                    '#newQuoteView [role="button"]',
                    '#newQuoteView a',
                    '#newQuoteView input[type="button"]',
                    '#newQuoteView input[type="submit"]',
                    '#newQuoteView [style*="cursor: pointer"]',
                    '#newQuoteView [tabindex]',
                    '#newQuoteView .btn',
                    '#newQuoteView .button'
                ];
                
                let elementsSupprimes = 0;
                
                selecteurs.forEach(selecteur => {
                    const elements = document.querySelectorAll(selecteur);
                    
                    elements.forEach((element, index) => {
                        const styles = window.getComputedStyle(element);
                        
                        // Crit√®res de suppression D√âFINITIVE
                        const doitEtreSuprime = (
                            // Texte blanc sur n'importe quel fond
                            styles.color === 'rgb(255, 255, 255)' || 
                            styles.color === '#ffffff' || 
                            styles.color === '#fff' || 
                            styles.color === 'white' ||
                            
                            // √âl√©ments transparents ou cach√©s
                            styles.opacity === '0' ||
                            styles.visibility === 'hidden' ||
                            
                            // Dans les zones probl√©matiques ET pas un bouton l√©gitime
                            (element.closest('.flex.items-center.justify-between.mb-4') && 
                             element.id !== 'backToQuotesBtn' && 
                             element.id !== 'saveQuoteBtn') ||
                             
                            (element.closest('.bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6') && 
                             element.id !== 'addServiceBtn') ||
                             
                            // Boutons sans texte visible mais avec cursor pointer
                            (styles.cursor === 'pointer' && 
                             !element.textContent.trim() && 
                             !element.querySelector('svg, img') &&
                             element.id !== 'backToQuotesBtn' && 
                             element.id !== 'saveQuoteBtn' && 
                             element.id !== 'addServiceBtn')
                        );
                        
                        // EXCEPTIONS - Ne JAMAIS supprimer ces boutons
                        const estProtege = (
                            element.id === 'backToQuotesBtn' ||
                            element.id === 'saveQuoteBtn' ||
                            element.id === 'addServiceBtn' ||
                            element.id === 'saveQuoteBtnMain' ||
                            element.tagName === 'INPUT' ||
                            element.tagName === 'TEXTAREA' ||
                            element.tagName === 'SELECT'
                        );
                        
                        if (doitEtreSuprime && !estProtege) {
                            console.log(`ÔøΩ SUPPRESSION D√âFINITIVE ${selecteur}[${index}]:`, {
                                element: element,
                                id: element.id,
                                classe: element.className,
                                texte: element.textContent?.trim().substring(0, 30),
                                couleur: styles.color,
                                cursor: styles.cursor,
                                parent: element.parentElement?.tagName
                            });
                            
                            // SUPPRESSION BRUTALE ET D√âFINITIVE
                            if (element.parentElement) {
                                element.parentElement.removeChild(element);
                            } else {
                                element.remove();
                            }
                            elementsSupprimes++;
                        }
                    });
                });
                
                console.log(`üî• ${elementsSupprimes} boutons supprim√©s d√©finitivement`);
                return elementsSupprimes;
            }
            
            // Suppression imm√©diate au chargement
            let totalSupprimes = supprimerTousBoutonsBlancs();
            
            // R√©p√©ter plusieurs fois pour attraper les √©l√©ments g√©n√©r√©s dynamiquement
            setTimeout(() => {
                totalSupprimes += supprimerTousBoutonsBlancs();
            }, 100);
            
            setTimeout(() => {
                totalSupprimes += supprimerTousBoutonsBlancs();
            }, 500);
            
            setTimeout(() => {
                totalSupprimes += supprimerTousBoutonsBlancs();
                console.log(`üíÄ SUPPRESSION D√âFINITIVE TERMIN√âE - ${totalSupprimes} boutons √©limin√©s au total`);
            }, 1000);
            
            // Observer les mutations DOM pour supprimer tout nouveau bouton blanc
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                // V√©rifier si le nouveau n≈ìud contient des boutons blancs
                                setTimeout(() => {
                                    const nouveauxBoutons = node.querySelectorAll ? 
                                        node.querySelectorAll('button, [onclick], [role="button"]') : [];
                                    
                                    nouveauxBoutons.forEach(bouton => {
                                        const styles = window.getComputedStyle(bouton);
                                        if (styles.color === 'rgb(255, 255, 255)' && 
                                            bouton.id !== 'backToQuotesBtn' && 
                                            bouton.id !== 'saveQuoteBtn' && 
                                            bouton.id !== 'addServiceBtn') {
                                            console.log('üö´ Nouveau bouton blanc d√©tect√© et supprim√©:', bouton);
                                            bouton.remove();
                                        }
                                    });
                                }, 10);
                            }
                        });
                    }
                });
            });
            
            // Surveiller la vue newQuoteView
            const newQuoteView = document.getElementById('newQuoteView');
            if (newQuoteView) {
                observer.observe(newQuoteView, {
                    childList: true,
                    subtree: true
                });
            }
            
            console.log('üî• SYST√àME DE SUPPRESSION D√âFINITIVE ACTIV√â');
        }
        
        // EX√âCUTER IMM√âDIATEMENT
        supprimerBoutonsInvisiblesDefinitif();
        
        // Fonction pour appeler la suppression quand la vue s'ouvre
        const originalShowNewQuoteView = window.showNewQuoteView;
        window.showNewQuoteView = function() {
            if (originalShowNewQuoteView) originalShowNewQuoteView();
            
            console.log('üìù Ouverture vue - Suppression boutons invisibles...');
            const view = document.getElementById('newQuoteView');
            if (view) {
                view.classList.remove('hidden');
                supprimerBoutonsInvisiblesDefinitif();
                
                // Diagnostic final apr√®s suppression
                setTimeout(() => {
                    console.log('üîç === DIAGNOSTIC FINAL ===');
                    
                    // V√©rifier tous les √©l√©ments dans les zones probl√©matiques
                    const headerZone = document.querySelector('#newQuoteView .flex.items-center.justify-between.mb-4');
                    if (headerZone) {
                        const clickableInHeader = headerZone.querySelectorAll('*');
                        clickableInHeader.forEach((el, index) => {
                            const style = window.getComputedStyle(el);
                            if (style.cursor !== 'default' || style.pointerEvents !== 'none') {
                                console.log(`‚ö†Ô∏è Header √©l√©ment ${index} encore cliquable:`, el.tagName, el.id, el.className);
                            }
                        });
                    }
                    
                    const prestationsZone = document.querySelector('#newQuoteView .bg-white.rounded-lg.shadow-sm.border.border-gray-200.p-6 .flex.items-center.justify-between');
                    if (prestationsZone) {
                        const clickableInPrestations = prestationsZone.querySelectorAll('*');
                        clickableInPrestations.forEach((el, index) => {
                            const style = window.getComputedStyle(el);
                            if (style.cursor !== 'default' || style.pointerEvents !== 'none') {
                                console.log(`‚ö†Ô∏è Prestations √©l√©ment ${index} encore cliquable:`, el.tagName, el.id, el.className);
                            }
                        });
                    }
                    
                    console.log('üîç DIAGNOSTIC TERMIN√â');
                }, 300);
            }
        };
        
        // Configuration finale termin√©e, listeners d√©finis dans setupQuoteCreation()
        console.log('‚úÖ Configuration FINALE termin√©e - uniquement vue plein √©cran');
    </script>
</body>
</html>