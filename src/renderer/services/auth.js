// Service d'authentification
class AuthService {
    constructor() {
        this.supabase = null;
        this.currentUser = null;
        this.isAuthenticated = false;
        console.log('üîß AuthService cr√©√©');
    }

    // Initialiser le service d'authentification
    async initialize() {
        console.log('üîß Initialisation du service d\'authentification...');
        
        try {
            // Attendre que supabaseAPI soit disponible
            let attempts = 0;
            while (!window.supabaseAPI && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.supabaseAPI) {
                console.log('üîÑ Mode d√©mo : supabaseAPI non disponible');
                this.currentUser = {
                    id: 'demo-user',
                    email: 'demo@example.com',
                    full_name: 'Utilisateur D√©mo'
                };
                this.isAuthenticated = true;
                console.log('‚úÖ AuthService initialis√© en mode d√©mo');
                return true;
            }

            if (!window.supabaseAPI.isConfigured()) {
                console.log('üîÑ Mode d√©mo : Authentification simul√©e');
                this.currentUser = {
                    id: 'demo-user',
                    email: 'demo@example.com',
                    full_name: 'Utilisateur D√©mo'
                };
                this.isAuthenticated = true;
                console.log('‚úÖ AuthService initialis√© en mode d√©mo (non configur√©)');
                return true;
            }

            const supabaseUrl = window.supabaseAPI.getSupabaseUrl();
            const supabaseKey = window.supabaseAPI.getSupabaseKey();
            console.log('üîó Configuration Supabase trouv√©e, URL:', supabaseUrl?.substring(0, 30) + '...');
            
            // Attendre que Supabase soit disponible
            attempts = 0;
            while (!window.supabase && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (!window.supabase) {
                console.error('‚ùå Supabase client non disponible');
                return false;
            }

            this.supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
            console.log('üîó Client Supabase cr√©√©');

            // V√©rifier si un utilisateur est d√©j√† connect√©
            const { data: { session } } = await this.supabase.auth.getSession();
            
            if (session?.user) {
                this.currentUser = session.user;
                this.isAuthenticated = true;
                console.log('‚úÖ Utilisateur d√©j√† connect√©:', session.user.email);
                
                // Transmettre l'utilisateur au service de base de donn√©es
                if (window.dbService && typeof window.dbService.setCurrentUser === 'function') {
                    window.dbService.setCurrentUser(session.user);
                    console.log('üë§ Utilisateur transmis au service de base de donn√©es');
                } else {
                    console.warn('‚ö†Ô∏è Service de base de donn√©es non disponible pour setCurrentUser');
                }
                
                return true;
            }

            console.log('‚úÖ AuthService initialis√© avec Supabase (aucun utilisateur connect√©)');
            return false;

        } catch (error) {
            console.error('‚ùå Erreur d\'initialisation de l\'authentification:', error);
            // En cas d'erreur, passer en mode d√©mo
            this.currentUser = {
                id: 'demo-user',
                email: 'demo@example.com',
                full_name: 'Utilisateur D√©mo'
            };
            this.isAuthenticated = true;
            console.log('‚úÖ AuthService initialis√© en mode d√©mo (erreur)');
            return true;
        }
    }

    // Connexion avec email/mot de passe
    async signIn(email, password) {
        // V√©rifier que les APIs sont disponibles
        if (!window.supabaseAPI || !window.supabaseAPI.isConfigured()) {
            return this.mockSignIn(email, password);
        }

        try {
            console.log('üîê Tentative de connexion...');
            console.log('üîë V√©rification configuration Supabase - Configur√©:', window.supabaseAPI.isConfigured());
            
            const { data, error } = await this.supabase.auth.signInWithPassword({
                email,
                password
            });

            if (error) {
                console.error('‚ùå Erreur Supabase connexion:', error);
                
                // Messages plus clairs pour les erreurs courantes
                if (error.message.includes('Email not confirmed')) {
                    console.log('üìß Email non confirm√©, tentative de bypass...');
                    
                    // Tentative d'inscription silencieuse pour bypasser la confirmation
                    try {
                        const { data: signUpData, error: signUpError } = await this.supabase.auth.signUp({
                            email,
                            password,
                            options: {
                                data: { full_name: 'Utilisateur' }
                            }
                        });
                        
                        if (!signUpError && signUpData.user) {
                            this.currentUser = signUpData.user;
                            this.isAuthenticated = true;
                            console.log('‚úÖ Connexion r√©ussie via inscription silencieuse');
                            return {
                                success: true,
                                user: signUpData.user
                            };
                        }
                    } catch (bypassError) {
                        console.log('‚ö†Ô∏è Bypass √©chou√©:', bypassError.message);
                    }
                    
                    throw new Error('Compte cr√©√© mais email non confirm√©. Utilisez un autre email ou contactez l\'admin.');
                } else if (error.message.includes('Invalid login credentials')) {
                    throw new Error('Email ou mot de passe incorrect');
                } else {
                    throw new Error(this.translateAuthError(error.message));
                }
            }

            this.currentUser = data.user;
            this.isAuthenticated = true;

            // Transmettre l'utilisateur au service de base de donn√©es
            if (window.dbService && typeof window.dbService.setCurrentUser === 'function') {
                window.dbService.setCurrentUser(data.user);
                console.log('üë§ Utilisateur transmis au service de base de donn√©es lors de la connexion');
            } else {
                console.warn('‚ö†Ô∏è Service de base de donn√©es non disponible pour setCurrentUser lors de la connexion');
            }

            console.log('‚úÖ Connexion r√©ussie:', data.user.email);
            return {
                success: true,
                user: data.user
            };

        } catch (error) {
            console.error('‚ùå Erreur de connexion:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // Inscription avec email/mot de passe
    async signUp(email, password, fullName) {
        console.log('üîÑ D√©but de l\'inscription pour:', email);
        
        // V√©rifier que les APIs sont disponibles
        if (!window.supabaseAPI || !window.supabaseAPI.isConfigured()) {
            console.log('üìß Mode d√©mo: inscription simul√©e');
            return this.mockSignUp(email, password, fullName);
        }

        try {
            console.log('üîó Tentative d\'inscription avec Supabase...');
            const { data, error } = await this.supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        full_name: fullName
                    },
                    emailRedirectTo: undefined // D√©sactiver la redirection email
                }
            });

            if (error) {
                console.error('‚ùå Erreur Supabase:', error);
                throw new Error(this.translateAuthError(error.message));
            }

            console.log('‚úÖ R√©ponse Supabase:', data);
            console.log('‚úÖ Inscription r√©ussie:', data.user?.email);
            
            // Si l'utilisateur est cr√©√©, on le connecte automatiquement
            if (data.user) {
                this.currentUser = data.user;
                this.isAuthenticated = true;
                console.log('üîÑ Connexion automatique apr√®s inscription');
            }
            
            return {
                success: true,
                user: data.user,
                message: data.user?.email_confirmed_at ? 
                    'Inscription et connexion r√©ussies !' : 
                    'Inscription r√©ussie ! Vous √™tes maintenant connect√©.'
            };

        } catch (error) {
            console.error('‚ùå Erreur d\'inscription:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // D√©connexion
    async signOut() {
        if (!window.supabaseAPI.isConfigured()) {
            this.currentUser = null;
            this.isAuthenticated = false;
            return { success: true };
        }

        try {
            const { error } = await this.supabase.auth.signOut();
            
            if (error) throw error;

            this.currentUser = null;
            this.isAuthenticated = false;

            console.log('‚úÖ D√©connexion r√©ussie');
            return { success: true };

        } catch (error) {
            console.error('‚ùå Erreur de d√©connexion:', error);
            return {
                success: false,
                error: error.message
            };
        }
    }

    // R√©initialisation de mot de passe
    async resetPassword(email) {
        if (!window.supabaseAPI.isConfigured()) {
            return {
                success: true,
                message: 'En mode d√©mo, la r√©initialisation n\'est pas disponible.'
            };
        }

        try {
            const { error } = await this.supabase.auth.resetPasswordForEmail(email);
            
            if (error) throw error;

            return {
                success: true,
                message: 'Instructions de r√©initialisation envoy√©es par email.'
            };

        } catch (error) {
            console.error('‚ùå Erreur de r√©initialisation:', error);
            return {
                success: false,
                error: this.translateAuthError(error.message)
            };
        }
    }

    // Obtenir l'utilisateur actuel
    getCurrentUser() {
        return this.currentUser;
    }

    // V√©rifier si l'utilisateur est authentifi√©
    isUserAuthenticated() {
        return this.isAuthenticated && this.currentUser;
    }

    // √âcouter les changements d'authentification
    onAuthStateChange(callback) {
        if (!window.supabaseAPI.isConfigured()) {
            // En mode d√©mo, appeler directement le callback
            if (this.isAuthenticated) {
                callback('SIGNED_IN', this.currentUser);
            }
            return;
        }

        this.supabase.auth.onAuthStateChange((event, session) => {
            console.log('üîÑ Changement d\'authentification:', event);
            
            if (event === 'SIGNED_IN' && session?.user) {
                this.currentUser = session.user;
                this.isAuthenticated = true;
            } else if (event === 'SIGNED_OUT') {
                this.currentUser = null;
                this.isAuthenticated = false;
            }

            callback(event, session);
        });
    }

    // === M√âTHODES DE D√âMONSTRATION ===
    mockSignIn(email, password) {
        console.log('Mode d√©mo: connexion simul√©e pour', email);
        
        // Simuler une connexion r√©ussie
        this.currentUser = {
            id: 'demo-user',
            email: email,
            full_name: 'Utilisateur D√©mo'
        };
        this.isAuthenticated = true;

        return {
            success: true,
            user: this.currentUser
        };
    }

    mockSignUp(email, password, fullName) {
        console.log('üìß Mode d√©mo: inscription simul√©e pour', email);
        
        // En mode d√©mo, on connecte automatiquement l'utilisateur apr√®s l'inscription
        this.currentUser = {
            id: 'demo-user',
            email: email,
            full_name: fullName
        };
        this.isAuthenticated = true;
        
        // Simuler une inscription r√©ussie
        return {
            success: true,
            user: this.currentUser,
            message: 'Inscription simul√©e r√©ussie en mode d√©mo ! Vous √™tes maintenant connect√©.'
        };
    }

    // Traduire les erreurs d'authentification
    translateAuthError(errorMessage) {
        const translations = {
            'Invalid login credentials': 'Email ou mot de passe incorrect',
            'Email not confirmed': 'Veuillez confirmer votre email avant de vous connecter',
            'User already registered': 'Un utilisateur existe d√©j√† avec cet email',
            'Password should be at least 6 characters': 'Le mot de passe doit contenir au moins 6 caract√®res',
            'Invalid email': 'Adresse email invalide',
            'Signup not allowed': 'L\'inscription n\'est pas autoris√©e',
            'Email rate limit exceeded': 'Trop de tentatives, veuillez patienter'
        };

        return translations[errorMessage] || errorMessage;
    }
}

// Exposer la classe globalement pour l'initialisation
window.AuthService = AuthService;
console.log('üìã AuthService classe expos√©e');

// Instance globale
window.authService = new AuthService();
console.log('üìã Instance authService cr√©√©e');
