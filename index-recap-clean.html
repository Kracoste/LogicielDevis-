<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Logiciel de Devis</title>
	<link rel="stylesheet" href="src/renderer/styles/output.css">
	
	<script>
		// 💎 SYSTÈME DE RÉCAPITULATIF SIMPLE ET EFFICACE
		console.log('💎 [RECAP] Système de récapitulatif simple en cours de chargement...');
		
		// Fonction simple de calcul des totaux
		function calculerTotaux() {
			console.log('🧮 [RECAP] Calcul des totaux en cours...');
			
			let totalHT = 0;
			
			// Récupérer tous les champs de prix et quantité
			const conteneurServices = document.getElementById('servicesContainerFullPage');
			if (!conteneurServices) {
				console.warn('⚠️ [RECAP] Container des services non trouvé');
				return;
			}
			
			// Parcourir toutes les lignes de prestations
			const lignesServices = conteneurServices.querySelectorAll('div');
			lignesServices.forEach((ligne, index) => {
				const champPrix = ligne.querySelector('input[name="service_price[]"]');
				const champQuantite = ligne.querySelector('input[name="service_quantity[]"]');
				
				if (champPrix && champQuantite) {
					const prix = parseFloat(champPrix.value) || 0;
					const quantite = parseFloat(champQuantite.value) || 1;
					const sousTotal = prix * quantite;
					
					if (prix > 0 && quantite > 0) {
						totalHT += sousTotal;
						console.log(`📊 [RECAP] Ligne ${index + 1}: ${quantite} × ${prix}€ = ${sousTotal}€`);
					}
				}
			});
			
			// Calculer TVA (20% par défaut)
			const selectTVA = document.getElementById('taxRateSelect');
			const tauxTVA = selectTVA ? parseFloat(selectTVA.value) / 100 : 0.20;
			const montantTVA = Math.round(totalHT * tauxTVA * 100) / 100;
			const totalTTC = Math.round((totalHT + montantTVA) * 100) / 100;
			
			// Mettre à jour l'affichage
			const elementSousTotalHT = document.getElementById('subtotalHT');
			const elementMontantTVA = document.getElementById('taxAmount');
			const elementTotalTTC = document.getElementById('totalTTC');
			
			if (elementSousTotalHT) {
				elementSousTotalHT.textContent = totalHT.toLocaleString('fr-FR', { 
					minimumFractionDigits: 2, 
					maximumFractionDigits: 2 
				}) + ' €';
			}
			
			if (elementMontantTVA) {
				elementMontantTVA.textContent = montantTVA.toLocaleString('fr-FR', { 
					minimumFractionDigits: 2, 
					maximumFractionDigits: 2 
				}) + ' €';
			}
			
			if (elementTotalTTC) {
				elementTotalTTC.textContent = totalTTC.toLocaleString('fr-FR', { 
					minimumFractionDigits: 2, 
					maximumFractionDigits: 2 
				}) + ' €';
			}
			
			console.log('✅ [RECAP] Totaux calculés:', { 
				totalHT: totalHT + '€', 
				montantTVA: montantTVA + '€', 
				totalTTC: totalTTC + '€'
			});
		}
		
		// Exposer la fonction globalement
		window.calculerTotaux = calculerTotaux;
		window.updateTotal = calculerTotaux; // Alias pour compatibilité
		
		// Fonction pour attacher les événements
		function attacherEvenements() {
			console.log('🔗 [RECAP] Attachement des événements...');
			
			// Attacher aux champs existants
			document.querySelectorAll('input[name="service_price[]"], input[name="service_quantity[]"]').forEach(champ => {
				champ.addEventListener('input', calculerTotaux);
				champ.addEventListener('change', calculerTotaux);
			});
			
			// Attacher au sélecteur de TVA
			const selectTVA = document.getElementById('taxRateSelect');
			if (selectTVA) {
				selectTVA.addEventListener('change', calculerTotaux);
			}
			
			console.log('✅ [RECAP] Événements attachés');
		}
		
		// Initialisation
		document.addEventListener('DOMContentLoaded', function() {
			console.log('🚀 [RECAP] DOM chargé, initialisation...');
			setTimeout(attacherEvenements, 500);
		});
		
		// Observer pour les nouveaux champs
		const observateur = new MutationObserver(function(mutations) {
			let nouveauxChamps = false;
			mutations.forEach(function(mutation) {
				if (mutation.type === 'childList') {
					mutation.addedNodes.forEach(function(noeud) {
						if (noeud.nodeType === 1 && noeud.querySelectorAll) {
							const nouveauxChampsPrix = noeud.querySelectorAll('input[name="service_price[]"]');
							const nouveauxChampsQuantite = noeud.querySelectorAll('input[name="service_quantity[]"]');
							
							if (nouveauxChampsPrix.length > 0 || nouveauxChampsQuantite.length > 0) {
								nouveauxChamps = true;
							}
						}
					});
				}
			});
			
			if (nouveauxChamps) {
				console.log('🆕 [RECAP] Nouveaux champs détectés, réattachement...');
				setTimeout(attacherEvenements, 100);
			}
		});
		
		// Démarrer l'observation
		setTimeout(function() {
			observateur.observe(document.body, {
				childList: true,
				subtree: true
			});
			console.log('👁️ [RECAP] Observateur activé');
		}, 1000);
		
		console.log('💎 [RECAP] Système initialisé');
	</script>
</head>
<body>
	<div style="padding: 20px;">
		<h1>Test du Récapitulatif Simple</h1>
		<p>Cette page de test sera utilisée pour valider le système de récapitulatif avant intégration.</p>
		
		<div id="servicesContainerFullPage">
			<div>
				<input type="number" name="service_quantity[]" value="1" step="0.01" style="margin: 5px;" placeholder="Quantité">
				<input type="number" name="service_price[]" value="0" step="0.01" style="margin: 5px;" placeholder="Prix">
			</div>
		</div>
		
		<div style="margin-top: 20px;">
			<div>Sous-total HT: <span id="subtotalHT">0,00 €</span></div>
			<div>TVA: <span id="taxAmount">0,00 €</span></div>
			<div>Total TTC: <span id="totalTTC">0,00 €</span></div>
			<select id="taxRateSelect">
				<option value="20">20%</option>
				<option value="10">10%</option>
				<option value="5.5">5.5%</option>
			</select>
		</div>
	</div>
</body>
</html>
