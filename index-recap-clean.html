<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Logiciel de Devis</title>
	<link rel="stylesheet" href="src/renderer/styles/output.css">
	
	<script>
		// ğŸ’ SYSTÃˆME DE RÃ‰CAPITULATIF SIMPLE ET EFFICACE
		console.log('ğŸ’ [RECAP] SystÃ¨me de rÃ©capitulatif simple en cours de chargement...');
		
		// Fonction simple de calcul des totaux
		function calculerTotaux() {
			console.log('ğŸ§® [RECAP] Calcul des totaux en cours...');
			
			let totalHT = 0;
			
			// RÃ©cupÃ©rer tous les champs de prix et quantitÃ©
			const conteneurServices = document.getElementById('servicesContainerFullPage');
			if (!conteneurServices) {
				console.warn('âš ï¸ [RECAP] Container des services non trouvÃ©');
				return;
			}
			
			// Parcourir toutes les lignes de prestations
			const lignesServices = conteneurServices.querySelectorAll('div');
			lignesServices.forEach((ligne, index) => {
				const champPrix = ligne.querySelector('input[name="service_price[]"]');
				const champQuantite = ligne.querySelector('input[name="service_quantity[]"]');
				
				if (champPrix && champQuantite) {
					const prix = parseFloat(champPrix.value) || 0;
					const quantite = parseFloat(champQuantite.value) || 1;
					const sousTotal = prix * quantite;
					
					if (prix > 0 && quantite > 0) {
						totalHT += sousTotal;
						console.log(`ğŸ“Š [RECAP] Ligne ${index + 1}: ${quantite} Ã— ${prix}â‚¬ = ${sousTotal}â‚¬`);
					}
				}
			});
			
			// Calculer TVA (20% par dÃ©faut)
			const selectTVA = document.getElementById('taxRateSelect');
			const tauxTVA = selectTVA ? parseFloat(selectTVA.value) / 100 : 0.20;
			const montantTVA = Math.round(totalHT * tauxTVA * 100) / 100;
			const totalTTC = Math.round((totalHT + montantTVA) * 100) / 100;
			
			// Mettre Ã  jour l'affichage
			const elementSousTotalHT = document.getElementById('subtotalHT');
			const elementMontantTVA = document.getElementById('taxAmount');
			const elementTotalTTC = document.getElementById('totalTTC');
			
			if (elementSousTotalHT) {
				elementSousTotalHT.textContent = totalHT.toLocaleString('fr-FR', { 
					minimumFractionDigits: 2, 
					maximumFractionDigits: 2 
				}) + ' â‚¬';
			}
			
			if (elementMontantTVA) {
				elementMontantTVA.textContent = montantTVA.toLocaleString('fr-FR', { 
					minimumFractionDigits: 2, 
					maximumFractionDigits: 2 
				}) + ' â‚¬';
			}
			
			if (elementTotalTTC) {
				elementTotalTTC.textContent = totalTTC.toLocaleString('fr-FR', { 
					minimumFractionDigits: 2, 
					maximumFractionDigits: 2 
				}) + ' â‚¬';
			}
			
			console.log('âœ… [RECAP] Totaux calculÃ©s:', { 
				totalHT: totalHT + 'â‚¬', 
				montantTVA: montantTVA + 'â‚¬', 
				totalTTC: totalTTC + 'â‚¬'
			});
		}
		
		// Exposer la fonction globalement
		window.calculerTotaux = calculerTotaux;
		window.updateTotal = calculerTotaux; // Alias pour compatibilitÃ©
		
		// Fonction pour attacher les Ã©vÃ©nements
		function attacherEvenements() {
			console.log('ğŸ”— [RECAP] Attachement des Ã©vÃ©nements...');
			
			// Attacher aux champs existants
			document.querySelectorAll('input[name="service_price[]"], input[name="service_quantity[]"]').forEach(champ => {
				champ.addEventListener('input', calculerTotaux);
				champ.addEventListener('change', calculerTotaux);
			});
			
			// Attacher au sÃ©lecteur de TVA
			const selectTVA = document.getElementById('taxRateSelect');
			if (selectTVA) {
				selectTVA.addEventListener('change', calculerTotaux);
			}
			
			console.log('âœ… [RECAP] Ã‰vÃ©nements attachÃ©s');
		}
		
		// Initialisation
		document.addEventListener('DOMContentLoaded', function() {
			console.log('ğŸš€ [RECAP] DOM chargÃ©, initialisation...');
			setTimeout(attacherEvenements, 500);
		});
		
		// Observer pour les nouveaux champs
		const observateur = new MutationObserver(function(mutations) {
			let nouveauxChamps = false;
			mutations.forEach(function(mutation) {
				if (mutation.type === 'childList') {
					mutation.addedNodes.forEach(function(noeud) {
						if (noeud.nodeType === 1 && noeud.querySelectorAll) {
							const nouveauxChampsPrix = noeud.querySelectorAll('input[name="service_price[]"]');
							const nouveauxChampsQuantite = noeud.querySelectorAll('input[name="service_quantity[]"]');
							
							if (nouveauxChampsPrix.length > 0 || nouveauxChampsQuantite.length > 0) {
								nouveauxChamps = true;
							}
						}
					});
				}
			});
			
			if (nouveauxChamps) {
				console.log('ğŸ†• [RECAP] Nouveaux champs dÃ©tectÃ©s, rÃ©attachement...');
				setTimeout(attacherEvenements, 100);
			}
		});
		
		// DÃ©marrer l'observation
		setTimeout(function() {
			observateur.observe(document.body, {
				childList: true,
				subtree: true
			});
			console.log('ğŸ‘ï¸ [RECAP] Observateur activÃ©');
		}, 1000);
		
		console.log('ğŸ’ [RECAP] SystÃ¨me initialisÃ©');
	</script>
</head>
<body>
	<div style="padding: 20px;">
		<h1>Test du RÃ©capitulatif Simple</h1>
		<p>Cette page de test sera utilisÃ©e pour valider le systÃ¨me de rÃ©capitulatif avant intÃ©gration.</p>
		
		<div id="servicesContainerFullPage">
			<div>
				<input type="number" name="service_quantity[]" value="1" step="0.01" style="margin: 5px;" placeholder="QuantitÃ©">
				<input type="number" name="service_price[]" value="0" step="0.01" style="margin: 5px;" placeholder="Prix">
			</div>
		</div>
		
		<div style="margin-top: 20px;">
			<div>Sous-total HT: <span id="subtotalHT">0,00 â‚¬</span></div>
			<div>TVA: <span id="taxAmount">0,00 â‚¬</span></div>
			<div>Total TTC: <span id="totalTTC">0,00 â‚¬</span></div>
			<select id="taxRateSelect">
				<option value="20">20%</option>
				<option value="10">10%</option>
				<option value="5.5">5.5%</option>
			</select>
		</div>
	</div>
</body>
</html>
